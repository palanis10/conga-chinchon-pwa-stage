<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Conga by Alanis — STAGE v3.5.7</title>

<!-- Prevent double-tap zoom / weird text scaling on iOS -->
<style>
  html,body{ -webkit-text-size-adjust:100%; }
  button,.btn,.chip,a,input,select,label{ touch-action:manipulation; }
</style>
<script>
(function(){
  // Soft block double-tap zoom without breaking tap events
  let last = 0;
  document.addEventListener('touchend', function(e){
    const now = Date.now();
    if (now - last <= 300) { e.preventDefault(); }
    last = now;
  }, {passive:false});
})();
</script>

<style>
  :root{
    --bg:#0b1020;
    --panel:#121933;
    --panel-2:#0e142b;
    --border:#314063;
    --chip:#1a2242;
    --chip-dash:#2a365b;
    --text:#e8edf8;
    --text-sub:#a9b6d7;
    --accent-a:#7aa7ff;
    --accent-b:#b39bff;
    --ok:#91f5be;
    --warn:#ffb86c;
    --bad:#ff6b6b;
    --ring:#2ad7a3;
    --shadow:0 24px 48px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, sans-serif;
    color:var(--text);
    background: radial-gradient(1200px 800px at 20% -10%, #162040, #0d1020 60%) fixed, var(--bg);
  }

  .wrap{max-width:980px;margin:0 auto;padding:20px 16px 120px}

  /* Header */
  .header{
    display:grid;
    grid-template-columns: 1fr auto auto;
    grid-template-areas:
      "title lang gear"
      "stage stage stage";
    align-items:center;
    gap:10px 16px;
    margin-bottom:10px;
  }
  .title{ grid-area:title; font-size:32px; font-weight:900; letter-spacing:.3px }
  .stage{ grid-area:stage; color:var(--text-sub); font-weight:800; letter-spacing:.08em; margin-top:-2px }
  .gear{ grid-area:gear }
  .lang{ grid-area:lang }

  .icon-btn{
    display:inline-grid; place-items:center;
    width:44px;height:44px;border-radius:12px;
    background:var(--panel); border:1px solid var(--border); cursor:pointer;
    box-shadow:var(--shadow);
  }
  .icon{width:22px;height:22px;filter:invert(92%) sepia(6%) saturate(245%) hue-rotate(188deg) brightness(104%) contrast(93%)}

      /* === v3.5.7 HOTFIX: header/chips sizing & spacing === */
.header{
  grid-template-columns: minmax(0,1fr) auto auto;
  align-items: center;
}
.title{
  /* keep on one line and scale sanely on small phones */
  font-size: clamp(18px, 6vw, 26px);
  line-height: 1.15;
  white-space: nowrap;
}
.stage{ margin-top: 2px; font-size: clamp(12px, 2.8vw, 14px); }

.lang-wrap{ transform: translateY(-2px); }

.controls{ margin-top: 6px; padding: 10px; gap: 10px; }
.chip{ padding: 10px 12px; font-size: clamp(13px, 3.6vw, 16px); }
.chip.solid{ padding: 10px 12px; }

.add{ gap: 8px; }            /* fixes “+Add player” tight spacing */
.avatar{ width: 58px; height: 58px; }   /* slightly smaller on compact widths */
.name, .score{ font-size: clamp(18px, 5.2vw, 24px); }

      
  /* Controls row */
  .controls{
    margin-top:8px;
    background:var(--panel-2);
    border:1px solid var(--border);
    border-radius:18px;
    padding:14px;
    display:flex; gap:14px; align-items:center; flex-wrap:nowrap;
    overflow:hidden;
  }
  .chip{
    display:inline-flex; align-items:center; gap:10px;
    border:1px dashed var(--chip-dash);
    background:var(--chip);
    padding:12px 16px; border-radius:14px; white-space:nowrap;
    font-weight:800;
  }
  .chip.solid{
    background: linear-gradient(135deg, var(--accent-a), var(--accent-b));
    border:0; color:#0b0f1b; padding:12px 18px;
  }
  .chip .lock{
    width:20px;height:20px;border-radius:4px;background:
      linear-gradient(#ffe8a6,#d6b65a);
    box-shadow:inset 0 -2px 0 rgba(0,0,0,.2);
  }

  /* Language toggle */
  .lang-wrap{
    display:inline-flex; gap:10px; align-items:center;
    background:var(--panel); border:1px solid var(--border); border-radius:14px;
    padding:6px 10px; box-shadow:var(--shadow);
  }
  .lang-chip{ padding:6px 8px; border-radius:10px; cursor:pointer; opacity:.6; font-weight:800 }
  .lang-chip.is-active{ background:#243056; opacity:1 }

  /* Section label */
  .section-h{ margin:18px 6px 8px; color:var(--text-sub); font-weight:700 }

  /* Player list */
  .card{
    background:linear-gradient(180deg, #111833, #0e1430);
    border:1px solid var(--border); border-radius:18px;
    padding:12px 14px; box-shadow:var(--shadow);
  }
  .players{ display:flex; flex-direction:column; gap:12px }

  .row{
    display:grid; grid-template-columns: 30px 74px 1fr auto; align-items:center;
    gap:12px; padding:10px 12px; border-radius:14px;
    outline:1px solid transparent; transition:box-shadow .15s, outline-color .15s;
  }
  .row.active{ outline-color:#1dbb91; box-shadow:0 0 0 3px rgba(29,187,145,.25) inset; }
  .handle{ width:30px;text-align:center; font-weight:900; color:var(--text-sub); cursor:grab }
  .avatar{
    width:64px;height:64px;border-radius:50%; display:grid; place-items:center;
    background:#0b132a;border:6px solid #213552; position:relative;
  }
  .ring{ position:absolute; inset:-6px; border-radius:50%; border:5px solid var(--ring); opacity:.9 }
  .initials{ font-weight:900; color:#cfe3ff }
  .name{ font-size:28px; font-weight:900 }
  .score{ font-size:28px; font-weight:900 }
  .score.bad{ color:var(--bad) }

  .add{
    display:flex; align-items:center; justify-content:center;
    height:64px; border-radius:16px; border:1px dashed var(--chip-dash); background:#0e1430;
    color:#dfe8ff; font-weight:800; cursor:pointer;
  }

  /* Dialogs */
  dialog{
    background:linear-gradient(180deg, #141b36, #101633);
    border:1px solid var(--border); border-radius:20px; color:var(--text);
    padding:16px; box-shadow:var(--shadow); width:min(580px, calc(100vw - 32px));
  }
  dialog::backdrop{ background:rgba(0,0,0,.6) }
  .modal-h{ display:flex; align-items:center; justify-content:space-between; gap:12px }
  .modal-title{ font-weight:900; font-size:20px }
  .btn{ background:#243056; border:1px dashed var(--chip-dash); border-radius:14px; padding:10px 14px; color:var(--text); font-weight:800; cursor:pointer }
  .btn.primary{ background:var(--ok); color:#0b1020; border:0 }
  .btn.danger{ background:#ff8989; color:#0b0f15; border:0 }
  .row-grid{ display:grid; gap:10px }
  .input{ width:100%; background:#0b132b; border:1px solid var(--border); border-radius:10px; padding:10px 12px; color:var(--text) }
  .inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }

  /* Responsive tightening for the control chips so they stay on one line */
  @media (max-width:420px){
    .chip{ padding:10px 12px; font-size:15px }
    .chip.solid{ padding:10px 12px }
    .name,.score{ font-size:24px }
    .avatar{ width:58px;height:58px }
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <header class="header">
    <div class="title">Conga by Alanis</div>
    <div class="lang">
      <div id="langToggleHeader" class="lang-wrap">
        <span class="lang-chip is-active" data-lang="en">EN</span>
        <span style="opacity:.45">|</span>
        <span class="lang-chip" data-lang="es">ES</span>
      </div>
    </div>
    <button id="settingsBtn" class="icon-btn gear" aria-label="Settings">
      <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14,12.94a7.43,7.43,0,0,0,.05-1,7.43,7.43,0,0,0-.05-1l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.28,7.28,0,0,0-1.73-1L13.5,2.5a.5.5,0,0,0-.5-.5H11a.5.5,0,0,0-.5.5L10,4.97a7.28,7.28,0,0,0-1.73,1l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L3.86,10a7.43,7.43,0,0,0-.05,1,7.43,7.43,0,0,0,.05,1L1.75,13.65a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.28,7.28,0,0,0,1.73,1L10,21.5a.5.5,0,0,0,.5.5h2a.5.5,0,0,0,.5-.5l.5-2.47a7.28,7.28,0,0,0,1.73-1l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
    </button>
    <div class="stage">STAGE v3.5.7</div>
  </header>

  <!-- Controls -->
  <div class="controls">
    <button id="lockBtn" class="chip"><span class="lock"></span><span data-i18n="reorder">Reorder</span></button>
    <button id="historyBtn" class="chip" title="History"><span data-i18n="history">History</span></button>
    <button id="newRoundBtn" class="chip solid"><span data-i18n="newRound">New round</span></button>
  </div>

  <div class="section-h" data-i18n="players">Players</div>

  <!-- Players -->
  <div id="playersCard" class="card">
    <div id="playersList" class="players"></div>
    <div id="addPlayerBtn" class="add" role="button">+ <span data-i18n="addPlayer">Add player</span></div>
  </div>

</div>

<!-- Settings dialog -->
<dialog id="settingsDialog" aria-labelledby="settingsTitle">
  <div class="modal-h">
    <div id="settingsTitle" class="modal-title" data-i18n="settings">Settings</div>
    <button class="btn" id="settingsCloseBtn" data-i18n="close">Close</button>
  </div>
  <div class="row-grid" style="margin-top:12px">
    <label class="inline">
      <span style="min-width:110px" data-i18n="language">Language</span>
      <select id="settingsLangSelect" class="input">
        <option value="en">English (EN)</option>
        <option value="es">Español (ES)</option>
      </select>
    </label>

    <label class="inline" style="justify-content:space-between">
      <span data-i18n="autoAdvance">Auto-advance dealer after round</span>
      <input id="autoAdvanceChk" type="checkbox" />
    </label>

    <label class="inline" style="justify-content:space-between">
      <span data-i18n="lockReorder">Lock player reordering</span>
      <input id="lockReorderChk" type="checkbox" />
    </label>

    <div class="inline" style="justify-content:flex-start; gap:8px; margin-top:8px">
      <button id="exportBtn" class="btn" data-i18n="exportCsv">Export CSV</button>
      <button id="resetBtn" class="btn" data-i18n="resetScores">Reset scores</button>
      <button id="clearBtn" class="btn danger" data-i18n="clearAll">Clear all</button>
    </div>

    <div style="display:flex; justify-content:flex-end; margin-top:8px">
      <button id="settingsDoneBtn" class="btn primary" data-i18n="done">Done</button>
    </div>
  </div>
</dialog>

<!-- New Round dialog -->
<dialog id="roundDialog" aria-labelledby="roundTitle">
  <div class="modal-h">
    <div id="roundTitle" class="modal-title" data-i18n="newRound">New round</div>
    <button id="roundClose" class="btn" data-i18n="close">Close</button>
  </div>
  <div style="height:10px"></div>
  <div id="roundForm" class="row-grid"></div>
  <div style="height:10px"></div>
  <div class="inline" style="justify-content:flex-end">
    <button id="roundCancel" class="btn" data-i18n="cancel">Cancel</button>
    <button id="roundApply" class="btn primary" data-i18n="apply">Apply</button>
  </div>
</dialog>

<script>
/* ===== Simple i18n ===== */
const I18N = {
  en:{
    reorder:"Reorder",
    history:"History",
    newRound:"New round",
    players:"Players",
    addPlayer:"Add player",
    settings:"Settings",
    close:"Close",
    language:"Language",
    autoAdvance:"Auto-advance dealer after round",
    lockReorder:"Lock player reordering",
    exportCsv:"Export CSV",
    resetScores:"Reset scores",
    clearAll:"Clear all",
    done:"Done",
    cancel:"Cancel",
    apply:"Apply",
    current:"Current",
    minus10:"–10",
    onlyOneMinus10:"Only one player may have –10 per round."
  },
  es:{
    reorder:"Reordenar",
    history:"Historial",
    newRound:"Nueva ronda",
    players:"Jugadores",
    addPlayer:"Agregar jugador",
    settings:"Ajustes",
    close:"Cerrar",
    language:"Idioma",
    autoAdvance:"Avanzar repartidor automáticamente",
    lockReorder:"Bloquear reordenamiento",
    exportCsv:"Exportar CSV",
    resetScores:"Reiniciar puntajes",
    clearAll:"Borrar todo",
    done:"Listo",
    cancel:"Cancelar",
    apply:"Aplicar",
    current:"Actual",
    minus10:"–10",
    onlyOneMinus10:"Solo un jugador puede tener –10 por ronda."
  }
};

/* ===== State ===== */
const state = loadState() || {
  players: [],
  history: [],
  settings: { lang:'en', autoAdvance:true, lockReorder:false, limit:100, dealerIndex:0 }
};

function saveState(){ localStorage.setItem('conga', JSON.stringify(state)); }
function loadState(){
  try{ return JSON.parse(localStorage.getItem('conga')); }catch(e){ return null; }
}

/* Ensure two default players on first load */
(function ensureDefaultPlayers(){
  if (!state.players || state.players.length === 0){
    state.players = [
      { id: crypto.randomUUID(), name:"Player 1", score:0 },
      { id: crypto.randomUUID(), name:"Player 2", score:0 }
    ];
    state.settings.dealerIndex = 0;
    saveState();
  }
})();

/* ===== Language plumbing (single source of truth) ===== */
function setLanguage(lang){
  lang = (lang==='es')?'es':'en';
  state.settings.lang = lang;
  document.documentElement.lang = lang;

  // header toggle
  document.querySelectorAll('.lang-chip').forEach(c => c.classList.toggle('is-active', c.dataset.lang===lang));
  // settings select
  const sel = document.getElementById('settingsLangSelect');
  if (sel) sel.value = lang;

  // text nodes
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (I18N[lang][key]) el.textContent = I18N[lang][key];
  });

  saveState();
}
function wireHeaderLang(){
  const wrap = document.getElementById('langToggleHeader');
  if (!wrap || wrap._wired) return;
  wrap._wired = true;
  wrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-lang]');
    if (!btn) return;
    setLanguage(btn.dataset.lang);
  });
}
function wireSettingsLang(){
  const sel = document.getElementById('settingsLangSelect');
  if (!sel || sel._wired) return;
  sel._wired = true;
  sel.addEventListener('change', e => setLanguage(e.target.value));
}

/* ===== UI rendering ===== */
const playersList = document.getElementById('playersList');
const addPlayerBtn = document.getElementById('addPlayerBtn');

function renderPlayers(){
  playersList.innerHTML = '';
  state.players.forEach((p, idx)=>{
    const row = document.createElement('div');
    row.className = 'row' + (idx===state.settings.dealerIndex ? ' active' : '');
    row.dataset.id = p.id;

    row.innerHTML = `
      <div class="handle">≡</div>
      <div class="avatar"><div class="ring"></div><div class="initials">${abbr(p.name)}</div></div>
      <div class="name">${escapeHtml(p.name)}</div>
      <div class="score ${p.score>=state.settings.limit ? 'bad':''}">${p.score}</div>
    `;

    // basic inline rename on name tap
    row.querySelector('.name').addEventListener('click', ()=>{
      const next = prompt('Name:', p.name);
      if (next && next.trim()){
        p.name = next.trim();
        saveState(); render();
      }
    });

    playersList.appendChild(row);
  });
}

function abbr(name){
  const parts = name.trim().split(/\s+/);
  if (parts.length===1) return parts[0].slice(0,2).toUpperCase();
  return (parts[0][0]+parts[1][0]).toUpperCase();
}

function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function render(){
  renderPlayers();
  // lock visual
  document.getElementById('lockReorderChk').checked = !!state.settings.lockReorder;
  document.getElementById('autoAdvanceChk').checked = state.settings.autoAdvance !== false;
}

/* ===== Add player ===== */
addPlayerBtn.addEventListener('click', ()=>{
  const n = state.players.length + 1;
  state.players.push({ id:crypto.randomUUID(), name:`Player ${n}`, score:0 });
  saveState(); render();
});

/* ===== Settings dialog ===== */
const settingsDialog = document.getElementById('settingsDialog');
document.getElementById('settingsBtn').addEventListener('click', ()=>{
  settingsDialog.showModal();
  wireSettingsLang();
});
document.getElementById('settingsCloseBtn').onclick =
document.getElementById('settingsDoneBtn').onclick = ()=> settingsDialog.close();

document.getElementById('lockReorderChk').addEventListener('change', (e)=>{
  state.settings.lockReorder = e.target.checked; saveState();
});
document.getElementById('autoAdvanceChk').addEventListener('change', (e)=>{
  state.settings.autoAdvance = e.target.checked; saveState();
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  state.players.forEach(p=>p.score=0);
  state.history = [];
  saveState(); render();
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if (!confirm('Clear all players and history?')) return;
  localStorage.removeItem('conga'); location.reload();
});
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const rows = [['Name','Score']].concat(state.players.map(p=>[p.name,p.score]));
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='conga-scores.csv'; a.click();
});

/* ===== New round dialog ===== */
const roundDialog = document.getElementById('roundDialog');
document.getElementById('newRoundBtn').addEventListener('click', openRoundModal);
document.getElementById('roundClose').onclick =
document.getElementById('roundCancel').onclick = ()=> roundDialog.close();
document.getElementById('roundApply').addEventListener('click', applyRound);

function openRoundModal(){
  const c = document.getElementById('roundForm');
  c.innerHTML = '';
  state.players.forEach((p,idx)=>{
    const wrap = document.createElement('div');
    wrap.className='row-grid';
    wrap.innerHTML = `
      <div style="font-weight:800">${escapeHtml(p.name)} — <span data-i18n="current">${I18N[state.settings.lang].current}</span>: ${p.score}</div>
      <div class="inline">
        <input class="input score-input" type="number" step="1" data-idx="${idx}" placeholder="0" />
        <button class="btn minus10" data-idx="${idx}">${I18N[state.settings.lang].minus10}</button>
      </div>
      <hr style="border:0;border-top:1px solid var(--border);opacity:.35">
    `;
    c.appendChild(wrap);
  });
  c.querySelectorAll('.minus10').forEach(b=>b.onclick=(e)=>{
    const i = +e.currentTarget.dataset.idx;
    const inp = c.querySelector(`.score-input[data-idx="${i}"]`);
    inp.value = -10;
  });
  roundDialog.showModal();
}

function applyRound(){
  const inputs = Array.from(document.querySelectorAll('#roundForm .score-input'));
  const values = inputs.map(i=>Number(i.value || 0));
  // enforce exactly at most one -10
  const minus10Count = values.filter(v=>v===-10).length;
  if (minus10Count>1){
    alert(I18N[state.settings.lang].onlyOneMinus10);
    return;
  }
  // apply
  values.forEach((delta,idx)=> state.players[idx].score += Number.isFinite(delta)?delta:0 );
  state.history.push({ t:Date.now(), values });
  // auto-advance dealer
  if (state.settings.autoAdvance !== false){
    state.settings.dealerIndex = (state.settings.dealerIndex + 1) % state.players.length;
  }
  saveState(); roundDialog.close(); render();
  checkWin();
}

/* ===== Simple win check: if anyone >= limit, lowest score wins ===== */
function checkWin(){
  const limit = state.settings.limit || 100;
  if (!state.players.some(p=>p.score>=limit)) return;
  const winner = [...state.players].sort((a,b)=>a.score-b.score)[0];
  const dlg = document.createElement('dialog');
  dlg.innerHTML = `
    <div class="modal-h">
      <div class="modal-title">${escapeHtml(winner.name)} won</div>
      <button class="btn">Close</button>
    </div>
    <div style="margin-top:14px;text-align:right">
      <button class="btn primary" id="newGameBtn">New game</button>
    </div>
  `;
  dlg.querySelector('.btn').onclick = ()=> dlg.close();
  dlg.addEventListener('close', ()=> dlg.remove());
  document.body.appendChild(dlg); dlg.showModal();
  dlg.querySelector('#newGameBtn').onclick = ()=>{
    state.players.forEach(p=>p.score=0);
    state.history=[]; saveState(); render(); dlg.close();
  };
}

/* ===== Reorder lock visual (no drag implementation in this compact build) ===== */
document.getElementById('lockBtn').addEventListener('click', ()=>{
  state.settings.lockReorder = !state.settings.lockReorder;
  saveState(); render();
});

/* ===== History button (quick peek) ===== */
document.getElementById('historyBtn').addEventListener('click', ()=>{
  const dlg = document.createElement('dialog');
  const list = state.history.map(h=>`<li>${new Date(h.t).toLocaleString()} — [${h.values.join(', ')}]</li>`).join('');
  dlg.innerHTML = `
    <div class="modal-h"><div class="modal-title">${I18N[state.settings.lang].history}</div>
      <button class="btn">${I18N[state.settings.lang].close}</button></div>
    <ul style="margin:12px 0 0 18px">${list || '<li>(empty)</li>'}</ul>`;
  dlg.querySelector('.btn').onclick = ()=> dlg.close();
  dlg.addEventListener('close', ()=> dlg.remove());
  document.body.appendChild(dlg); dlg.showModal();
});

/* ===== Boot ===== */
wireHeaderLang();
setLanguage(state.settings.lang || 'en');
render();

</script>
</body>
</html>
