<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Conga Alanis â€” STAGE</title>
<link rel="manifest" href="data:application/manifest+json,{\n  \"name\": \"Conga Alanis\",\n  \"short_name\": \"Conga\",\n  \"display\": \"standalone\",\n  \"start_url\": \".\",\n  \"theme_color\": \"#0f172a\",\n  \"background_color\": \"#0f172a\",\n  \"icons\": []\n}" />
<style>
  :root{
    --bg:#0b1220; /* deep navy */
    --card:#121a2b; /* slate */
    --muted:#93a4c8; /* muted text */
    --text:#e6ecff;
    --accent:#7c9cff; /* periwinkle */
    --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --shadow:0 8px 24px rgba(10,14,28,.35);
    --radius:18px;
  }
  html,body{height:100%;}
  body{margin:0;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial; background:radial-gradient(1200px 600px at 70% -10%, rgba(124,156,255,.15), transparent), var(--bg); color:var(--text); -webkit-text-size-adjust:100%;}
  .app{max-width:820px;margin:0 auto;padding:20px 16px 120px;}
  header{display:flex;align-items:center;gap:12px;}
  .badge{background:linear-gradient(135deg, #1f2a44, #0f172a); padding:8px 14px; border-radius:999px; font-weight:700; box-shadow:var(--shadow);}
  .title{font-size:20px;font-weight:800;letter-spacing:.2px;}
  .topbar{display:flex;align-items:center;gap:10px;margin-left:auto;}
  button, .btn{background:#1b2440;border:1px solid rgba(255,255,255,.08); color:var(--text); padding:10px 14px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:.2s transform,.2s background,.2s opacity; font-size:14px;}
  button:active{transform:scale(.98)}
  .iconbtn{display:inline-flex;align-items:center;gap:8px}
  .icon{width:22px;height:22px;display:inline-grid;place-items:center;}
  .gear{font-size:18px}
  .row{display:flex;align-items:center;gap:10px}
  .stack{display:flex;flex-direction:column;gap:10px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}
  .players{display:flex;flex-direction:column; gap:10px}

  /* Player Row */
  .player{display:grid; grid-template-columns: 1fr auto auto auto auto; align-items:center; gap:8px; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06);}
  .handle{cursor:grab; user-select:none; padding:6px 8px; opacity:.7}
  .name{font-size:18px; font-weight:800; line-height:1.1}
  .muted{color:var(--muted); font-weight:600}
  .tag{display:inline-flex;align-items:center; gap:6px; font-weight:800; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08)}
  .star{filter: drop-shadow(0 2px 4px rgba(255,215,0,.35));}
  .score{min-width:64px; text-align:right; font-weight:900; font-size:20px}
  .edit{padding:10px 12px; font-size:15px}
  .lock{padding:10px 12px; font-size:15px}
  .lock[data-locked="true"]{background:rgba(245,158,11,.15); border-color:rgba(245,158,11,.3)}
  .dealer{padding:8px 10px; border-radius:12px; background:rgba(124,156,255,.12); border:1px solid rgba(124,156,255,.25); font-weight:800}
  .dealer.isDealer{background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.35)}

  .sectionbar{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .sectionbar h2{margin:0; font-size:16px; letter-spacing:.2px}

  /* History Table */
  table{width:100%; border-collapse:collapse;}
  th,td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right}
  th:first-child, td:first-child{text-align:left}

  /* New Round Modal */
  dialog{border:none; border-radius:18px; padding:0; background:transparent}
  .modal{background:var(--card); border:1px solid rgba(255,255,255,.1); border-radius:18px; max-width:720px; width:92vw; box-shadow: var(--shadow);}
  .modal header{padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.08)}
  .modal .content{padding:12px 12px 6px; max-height:65vh; overflow:auto}
  .formrow{display:grid; grid-template-columns: 1fr auto auto auto; gap:8px; align-items:center; padding:8px; border-radius:12px; border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.02)}
  .formrow .pname{font-weight:800}
  .num{width:86px; font-size:18px; padding:10px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0d1426; color:var(--text)}
  .num::-webkit-outer-spin-button, .num::-webkit-inner-spin-button{appearance:none;margin:0}
  .quick{padding:10px 12px}
  .cutter{display:flex; align-items:center; gap:6px; justify-content:flex-end}
  .actions{display:flex; gap:10px; padding:14px; border-top:1px solid rgba(255,255,255,.08); justify-content:flex-end}

  /* Toasts & Banner */
  .banner{margin:12px 0; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04)}
  .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); font-weight:800}

  /* Win overlay */
  #overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:60}
  #overlay.show{display:grid}
  .win{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)), #0d1426; border:1px solid rgba(255,255,255,.14); padding:26px; border-radius:22px; text-align:center; box-shadow: var(--shadow)}
  .win h1{margin:0 0 6px; font-size:26px}
  .win p{margin:0 0 14px; color:var(--muted)}
  .win .big{font-size:40px; font-weight:900}
  canvas#confetti{position:fixed; inset:0; pointer-events:none}

  /* Utilities */
  .hidden{display:none}
  .grow{flex:1}
  .right{margin-left:auto}

  /* Make controls >=16px font to avoid iOS zoom */
  input, select, textarea, button {font-size:16px}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="app">
  <header>
    <span class="badge">Conga <span class="muted">Alanis</span> â€” <span class="muted">STAGE</span></span>
    <div class="topbar">
      <button id="btnNewRound" class="iconbtn" title="Add scores (New Round)">â• <span>New Round</span></button>
      <button id="btnHistory" class="iconbtn">ğŸ“œ <span>History</span></button>
      <button id="btnReset" class="iconbtn" title="Reset game">ğŸ—‘ï¸ Reset</button>
      <button id="btnSettings" class="iconbtn" title="Settings"><span class="gear">âš™ï¸</span> Settings</button>
    </div>
  </header>

  <div class="banner row">
    <strong>Next dealer:</strong>
    <span id="nextDealerName" class="pill">â€”</span>
    <span class="muted">(Tap ğŸ´ on a player to set dealer â€¢ Autoâ€‘advance ON)</span>
  </div>

  <section class="card stack" id="playersSection">
    <div class="sectionbar">
      <h2>Players</h2>
      <div class="row" style="gap:8px">
        <button id="btnAddPlayer" class="iconbtn">ğŸ‘¤â• Add Player</button>
      </div>
    </div>
    <div class="players" id="players"></div>
  </section>

  <section class="card stack" id="historySection" style="margin-top:14px">
    <div class="sectionbar">
      <h2>History (Totals per round)</h2>
      <span class="muted">Tap a row to expand</span>
    </div>
    <div id="history"></div>
  </section>
</div>

<!-- New Round Modal -->
<dialog id="roundDialog">
  <div class="modal">
    <header class="row">
      <strong class="title">New Round</strong>
      <span class="muted">Enter scores. Cutter cannot exceed 100.</span>
      <span class="right"></span>
      <button class="btn" id="closeRound">âœ–</button>
    </header>
    <div class="content" id="roundForm"></div>
    <div class="actions">
      <button class="btn" id="cancelRound">Cancel</button>
      <button class="btn" id="applyRound" style="background:linear-gradient(180deg, rgba(34,197,94,.15), rgba(34,197,94,.08)); border-color:rgba(34,197,94,.35)">Apply</button>
    </div>
  </div>
</dialog>

<div id="overlay"><div class="win">
  <div class="big">ğŸ‰</div>
  <h1 id="winTitle">Winner!</h1>
  <p id="winSubtitle">â€”</p>
  <audio id="winSound" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAA" type="audio/mpeg" />
  </audio>
  <div class="row" style="justify-content:center; gap:10px; margin-top:12px">
    <button id="closeWin" class="btn">Close</button>
    <button id="resetWin" class="btn" style="background:rgba(124,156,255,.18); border-color:rgba(124,156,255,.35)">New Game</button>
  </div>
</div></div>

<script>
/** ==========================
 * Conga Alanis â€” STAGE Build
 * Single-file, no frameworks. PWA-friendly.
 * ========================== */
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
const uid = () => Math.random().toString(36).slice(2,9);

const STORAGE_KEY = 'conga-alanis-stage-v2';

/** State */
let state = load() || {
  limit: 100,
  players: [
    {id: uid(), name: 'Player 1', score: 0, reenganches: 0, locked: false},
    {id: uid(), name: 'Player 2', score: 0, reenganches: 0, locked: false},
  ],
  nextDealerId: null,
  autoAdvanceDealer: true,
  rounds: [] // each: {id, inputs: {playerId: value}, cutterId, totals:{playerId: newScore}}
};
if(!state.nextDealerId && state.players[0]) state.nextDealerId = state.players[0].id;

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch{ return null; } }
function reset(){ localStorage.removeItem(STORAGE_KEY); location.reload(); }

/** UI Rendering */
function render(){
  renderPlayers();
  renderDealerBanner();
  renderHistory();
}

function renderDealerBanner(){
  const dealer = state.players.find(p=>p.id===state.nextDealerId);
  $('#nextDealerName').textContent = dealer? dealer.name : 'â€”';
}

function playerRow(p){
  const row = document.createElement('div');
  row.className = 'player';
  row.draggable = true;
  row.dataset.id = p.id;
  row.innerHTML = `
    <div class="row" style="gap:8px; min-width:0">
      <span class="handle" title="Drag to reorder">â‰¡</span>
      <div class="stack" style="gap:4px; min-width:0">
        <div class="name" contenteditable="${!p.locked}" spellcheck="false">${escapeHTML(p.name)}</div>
        <div class="muted" style="font-size:12px;">Tap ğŸ´ to set dealer â€¢ Drag â‰¡ to reorder</div>
      </div>
    </div>
    <button class="dealer ${p.id===state.nextDealerId?'isDealer':''}" title="Set next dealer" data-role="dealer">ğŸ´</button>
    <span class="tag" title="Reenganche count"><span class="star">â­</span><span class="count">${p.reenganches}</span></span>
    <div class="score" title="Total score">${p.score}</div>
    <button class="edit" data-role="edit" title="Edit player">âœï¸ Edit</button>
    <button class="lock" data-role="lock" title="${p.locked?'Unlock name':'Lock name'}" data-locked="${p.locked}">${p.locked?'ğŸ”’':'ğŸ”“'}</button>
  `;

  // Edit handling (bigger hit target)
  row.querySelector('[data-role="edit"]').addEventListener('click', ()=>{
    const nameEl = row.querySelector('.name');
    if(row.querySelector('[data-role="lock"]').dataset.locked === 'true') return; // locked
    nameEl.focus();
    selectAllContent(nameEl);
  });
  row.querySelector('.name').addEventListener('blur', (e)=>{
    const newName = e.currentTarget.textContent.trim() || 'Player';
    p.name = newName; save(); renderDealerBanner();
  });

  // Lock toggle (more obvious)
  row.querySelector('[data-role="lock"]').addEventListener('click', (e)=>{
    const btn = e.currentTarget; const locked = btn.dataset.locked === 'true';
    p.locked = !locked; btn.dataset.locked = String(p.locked); btn.textContent = p.locked?'ğŸ”’':'ğŸ”“';
    btn.title = p.locked? 'Unlock name':'Lock name'; save();
  });

  // Dealer set
  row.querySelector('[data-role="dealer"]').addEventListener('click', ()=>{
    state.nextDealerId = p.id; save(); renderDealerBanner(); renderPlayers();
  });

  // Drag & Drop
  row.addEventListener('dragstart', (e)=>{
    e.dataTransfer.setData('text/plain', p.id);
    row.style.opacity = .5;
  });
  row.addEventListener('dragend', ()=> row.style.opacity = 1);
  row.addEventListener('dragover', (e)=>{ e.preventDefault(); row.style.outline='1px dashed rgba(255,255,255,.25)'; });
  row.addEventListener('dragleave', ()=> row.style.outline='none');
  row.addEventListener('drop', (e)=>{
    e.preventDefault(); row.style.outline='none';
    const fromId = e.dataTransfer.getData('text/plain');
    const toId = p.id;
    reorderPlayers(fromId, toId);
  });

  return row;
}

function renderPlayers(){
  const wrap = $('#players');
  wrap.innerHTML = '';
  state.players.forEach(p=> wrap.appendChild(playerRow(p)) );
}

function reorderPlayers(fromId, toId){
  const list = state.players.slice();
  const fromIndex = list.findIndex(p=>p.id===fromId);
  const toIndex = list.findIndex(p=>p.id===toId);
  if(fromIndex<0 || toIndex<0) return;
  const [moved] = list.splice(fromIndex,1);
  list.splice(toIndex,0,moved);
  // keep dealer by id (no change to nextDealerId)
  state.players = list; save(); render();
}

/** History */
function renderHistory(){
  const host = $('#history');
  if(state.rounds.length===0){ host.innerHTML = `<div class="muted">No rounds yet.</div>`; return; }
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const hdr = document.createElement('tr');
  hdr.innerHTML = `<th>#</th>` + state.players.map(p=>`<th>${escapeHTML(p.name)}</th>`).join('');
  thead.appendChild(hdr); table.appendChild(thead);
  const tb = document.createElement('tbody');
  state.rounds.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>` + state.players.map(p=>`<td>${r.totals[p.id] ?? ''}</td>`).join('');
    tr.title = `Cutter: ${playerName(r.cutterId) || 'â€”'}`;
    tb.appendChild(tr);
  });
  table.appendChild(tb);
  host.innerHTML = ''; host.appendChild(table);
}

/** New Round */
function openRound(){
  const form = $('#roundForm');
  form.innerHTML = '';
  state.players.forEach(p=>{
    const row = document.createElement('div'); row.className='formrow'; row.dataset.id=p.id;
    row.innerHTML = `
      <div class="pname">${escapeHTML(p.name)}</div>
      <input class="num" inputmode="numeric" pattern="[0-9\-]*" placeholder="0" />
      <button class="quick">âˆ’10</button>
      <label class="cutter"><input type="radio" name="cutter" value="${p.id}"> Cutter</label>
    `;
    row.querySelector('.quick').addEventListener('click', (e)=>{
      e.preventDefault(); const inp=row.querySelector('.num');
      const v=parseInt(inp.value||'0',10); inp.value = String(v-10); inp.dispatchEvent(new Event('input'));
    });
    form.appendChild(row);
  });
  $('#applyRound').disabled=false;
  $('#roundDialog').showModal();
}

function getRoundInputs(){
  const map = {}; const rows = $$('.formrow', $('#roundForm'));
  rows.forEach(row=>{
    const id = row.dataset.id; const raw = row.querySelector('.num').value.trim();
    const v = raw==='' ? 0 : Number(raw);
    map[id] = isFinite(v)? v : 0;
  });
  const cutter = $('#roundForm input[name="cutter"]:checked');
  return {inputs:map, cutterId: cutter? cutter.value : null};
}

function applyRound(){
  const {inputs, cutterId} = getRoundInputs();
  // Projected scores
  const projected = Object.fromEntries(state.players.map(p=> [p.id, p.score + (inputs[p.id]||0)]));

  // Validation: cutter cannot exceed 100
  if(cutterId){
    if(projected[cutterId] > state.limit){
      alert('Cutter cannot exceed 100.'); return;
    }
  }

  // Apply deltas to state
  state.players.forEach(p=>{ p.score = projected[p.id]; });

  // Reenganche: ONLY when a player hits EXACTLY 101
  state.players.forEach(p=>{
    if(p.score===state.limit+1){
      // find max <= limit among ALL players (after deltas applied)
      const elig = state.players.map(x=>x.score).filter(s=> s<=state.limit);
      const maxLE = elig.length? Math.max(...elig): 0;
      p.score = maxLE;
      p.reenganches += 1;
    }
  });

  // Instant-win: If cutterId is set AND cutter<=100 and all others>100
  if(cutterId){
    const cutterScore = state.players.find(p=>p.id===cutterId)?.score ?? 9999;
    const others = state.players.filter(p=>p.id!==cutterId);
    if(cutterScore<=state.limit && others.every(o=> o.score>state.limit)){
      commitRound(inputs, cutterId);
      announceWinner(cutterId, 'Cutter â‰¤100 and all others >100 (instant win).');
      return;
    }
  }

  // Advance dealer (always ON)
  if(state.autoAdvanceDealer && state.players.length){
    const idx = state.players.findIndex(p=>p.id===state.nextDealerId);
    const next = state.players[(idx+1) % state.players.length];
    if(next) state.nextDealerId = next.id;
  }

  commitRound(inputs, cutterId);
}

function commitRound(inputs, cutterId){
  // Store totals snapshot for history row
  const totals = Object.fromEntries(state.players.map(p=> [p.id, p.score]));
  state.rounds.push({id: uid(), inputs, cutterId, totals});
  save(); render();
  $('#roundDialog').close();
}

/** Winner Overlay + Confetti */
function announceWinner(playerId, reason){
  const name = playerName(playerId) || 'Unknown';
  $('#winTitle').textContent = `${name} wins!`;
  $('#winSubtitle').textContent = reason || '';
  $('#overlay').classList.add('show');
  try{ $('#winSound').play().catch(()=>{});}catch{}
  startConfetti();
}

function playerName(id){ return state.players.find(p=>p.id===id)?.name || null; }

/** Helpers */
function escapeHTML(s){ return s.replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
function selectAllContent(el){ const r = document.createRange(); r.selectNodeContents(el); const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(r); }

/** Confetti / Fireworks (simple) */
let confettiTimer;
function startConfetti(){
  const cvs = $('#confetti');
  const ctx = cvs.getContext('2d');
  const DPR = window.devicePixelRatio||1; const W=window.innerWidth, H=window.innerHeight; cvs.width=W*DPR; cvs.height=H*DPR; ctx.scale(DPR,DPR);
  const pieces = Array.from({length: 180}, ()=>({
    x: Math.random()*W, y: -10 - Math.random()*H, r: 2+Math.random()*4, vy: 2+Math.random()*3, vx: -1+Math.random()*2, a: Math.random()*Math.PI*2
  }));
  cancelAnimationFrame(confettiTimer);
  function tick(){
    ctx.clearRect(0,0,W,H);
    pieces.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.a+=0.1;
      if(p.y>H+20){ p.y=-20; p.x=Math.random()*W; }
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
      ctx.fillStyle = `hsl(${Math.floor(Math.random()*360)},90%,60%)`;
      ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2);
      ctx.restore();
    });
    confettiTimer = requestAnimationFrame(tick);
  }
  tick();
}

/** Events */
$('#btnAddPlayer').addEventListener('click', ()=>{
  state.players.push({id:uid(), name:`Player ${state.players.length+1}`, score:0, reenganches:0, locked:false});
  save(); render();
});
$('#btnNewRound').addEventListener('click', openRound);
$('#btnHistory').addEventListener('click', ()=>{
  window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
});
$('#btnReset').addEventListener('click', ()=>{
  if(confirm('Reset game and clear all data?')) reset();
});
$('#btnSettings').addEventListener('click', ()=>{
  alert('Autoâ€‘advance dealer is always ON in this STAGE build. Drag to reorder; tap ğŸ´ to set the next dealer. Reenganche only at 101. Cutter cannot exceed 100.');
});
$('#closeRound').addEventListener('click', ()=> $('#roundDialog').close());
$('#cancelRound').addEventListener('click', ()=> $('#roundDialog').close());
$('#applyRound').addEventListener('click', applyRound);

$('#closeWin').addEventListener('click', ()=>{ $('#overlay').classList.remove('show'); cancelAnimationFrame(confettiTimer); });
$('#resetWin').addEventListener('click', ()=>{ cancelAnimationFrame(confettiTimer); reset(); });

window.addEventListener('beforeunload', ()=> cancelAnimationFrame(confettiTimer));

// Initial
render();

// Register a tiny SW for PWA (optional)
if('serviceWorker' in navigator){
  const sw = URL.createObjectURL(new Blob([`
    self.addEventListener('install', e=> self.skipWaiting());
    self.addEventListener('activate', e=> self.clients.claim());
    self.addEventListener('fetch', e=> e.respondWith(fetch(e.request).catch(()=>new Response('Offline',{status:200}))));
  `], {type:'text/javascript'}));
  navigator.serviceWorker.register(sw);
}
</script>
</body>
</html>
