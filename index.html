Here you go ‚Äî full file you can paste into GitHub:

```html
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=5" />
<title>Conga / Chinch√≥n ‚Äì Alanis Scorekeeper ‚Äî STAGE v3.4</title>
<meta name="theme-color" content="#0f1220" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-512.png">
<link rel="manifest" href="manifest.webmanifest">
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --muted:#2a2f4a; --text:#e8ecff; --sub:#b8c0ff;
    --accent:#7aa2ff; --accent-2:#4ee1a0; --danger:#ff6b6b; --warn:#ffb020;
    --shadow: 0 8px 24px rgba(0,0,0,.35); --radius:16px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, sans-serif;
    background: radial-gradient(1200px 800px at 20% -10%, #162040, #0d1020 60%) fixed, var(--bg);
    color:var(--text); -webkit-font-smoothing:antialiased; line-height:1.35;}
  .app{max-width:980px; margin:0 auto; padding:10px 12px 120px;}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:2px 0 8px 0;}
  .top-left{display:flex; align-items:center; gap:10px}
  .chip{background:linear-gradient(135deg, var(--accent), #a77dff); color:#0b0f1f; padding:3px 10px; border-radius:999px; font-weight:800; font-size:11px; text-transform:uppercase; letter-spacing:.6px;}
  .brand{opacity:.95; font-weight:900; letter-spacing:.2px; font-size: clamp(16px, 4vw, 22px);} 
  .ver{opacity:.7; font-weight:800; font-size:12px; margin-left:4px}
  .btn{appearance:none; border:0; cursor:pointer; user-select:none; padding:9px 12px; border-radius:12px;
    background: linear-gradient(135deg, #1a2344, #121a34); border:1px solid rgba(255,255,255,.08);
    color:var(--text); font-weight:700; letter-spacing:.2px; transition:.15s;}
  .btn:hover{ filter:brightness(1.07)} .btn:active{ transform:translateY(1px)}
  .btn.primary{background: linear-gradient(135deg, var(--accent), #9f7cff); color:#0b0f1f;}
  .btn.success{background: linear-gradient(135deg, var(--accent-2), #9cffc8); color:#001c12;}
  .btn.warn{background: linear-gradient(135deg, #ffb020, #ffd27a); color:#2d1500;}
  .btn.ghost{background: transparent; border:1px dashed rgba(255,255,255,.2);} 
  .iconbtn{ width:44px; height:44px; display:grid; place-items:center; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f1428; color:var(--text); cursor:pointer; font-size:18px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)) , var(--card);
    border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow); padding:12px;}
  .players header{ margin:0 0 6px 2px; color:var(--sub); font-size:12px; }
  .row{
    display:grid;
    grid-template-columns: 28px 64px 1fr auto; /* drag | avatar | name | stars+score */
    align-items:center; gap:10px;
    padding:10px; border-radius:14px;
    border:1px solid rgba(255,255,255,.06);
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    margin-bottom:8px;
  }
  .drag{ cursor:grab; text-align:center; font-size:18px; color:var(--sub) }
  .drag.locked{ filter:grayscale(1); opacity:.5; cursor:not-allowed }
  .row.dealer{ border-color: rgba(78,225,160,.6); box-shadow: 0 0 0 2px rgba(78,225,160,.25) inset; }
  .avatar{ width:56px; height:56px; border-radius:50%; display:grid; place-items:center;
    background:#0f1428; border:1px solid rgba(255,255,255,.14); overflow:hidden; font-weight:800;}
  .row.dealer .avatar{ box-shadow: 0 0 0 3px #4ee1a0, 0 0 0 6px rgba(78,225,160,.25); }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .playerName{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; line-height:1.1; font-size:22px; font-weight:900; }
  .scorewrap{ display:flex; align-items:center; gap:8px; min-width:86px; justify-content:flex-end; }
  .stars{ color:var(--danger); font-weight:900; font-size:16px; white-space:nowrap; margin-right:2px }
  .score{ font-variant-numeric: tabular-nums; font-weight:900; text-align:right; font-size:22px; }
  .score.over{ color:var(--danger) }
  .banner{ margin:10px 0; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.1);
    background: linear-gradient(90deg, rgba(78,225,160,.15), rgba(122,162,255,.1)); color:#d7fff0; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
  .banner .tag{ background:#0f1428; border:1px solid rgba(255,255,255,.08); padding:4px 8px; border-radius:999px; font-size:12px; color:#b8c0ff }
  dialog{ width:min(720px, 96vw); border-radius:16px; border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)) , #0f1428; color:var(--text);
    box-shadow: 0 24px 64px rgba(0,0,0,.55); }
  dialog::backdrop{ background: rgba(2,6,23,.55) }
  .modal-head{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between; gap:10px }
  .modal-body{ padding:12px 14px } .modal-foot{ padding:12px 14px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap }
  label{font-size:12px; color:var(--sub); display:block; margin-bottom:6px}
  input[type="number"], input[type="text"], select{width:100%; background:#0f1428; border:1px solid var(--muted);
    color:var(--text); padding:9px 10px; border-radius:12px; outline:none; height:38px;}
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0;}
  /* Prevent iOS auto-zoom on focus */
  input, select, textarea, button { font-size:16px; }
  .switch{display:flex; align-items:center; gap:10px; background:#0f1428; border:1px solid var(--muted); padding:8px 10px; border-radius:12px; height:38px;}
  .grid-rows{ display:grid; gap:6px }
  .round-row{ display:grid; grid-template-columns: 1fr 100px 56px 36px; gap:8px; align-items:center;
    padding:6px; border:1px dashed rgba(255,255,255,.15); border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); }
  .round-row input[type="number"]{ height:34px; padding:6px 8px; }
  .round-row .minus10{ width:100%; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(135deg, #1c243e, #121a34); color:var(--text); font-weight:800; padding:0 4px; }
  .r-cutter{ width:34px; height:34px; display:grid; place-items:center; border-radius:10px; border:1px dashed rgba(255,255,255,.20); }
  .r-cutter input{ width:16px; height:16px; }
  .error{ color:var(--danger); font-weight:700; margin-right:auto }
  .hint{ color:var(--sub); font-size:12px }
  .table-wrap{ overflow:auto; max-height:60vh; border:1px solid rgba(255,255,255,.12); border-radius:12px;}
  table{ width:max(520px,100%); border-collapse:separate; border-spacing:0; }
  thead th{ position:sticky; top:0; background:#121633; border-bottom:1px solid rgba(255,255,255,.12); padding:10px; text-align:center; font-weight:800;}
  tbody td, tbody th{ padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.06); text-align:center; font-variant-numeric:tabular-nums; }
  tbody tr:nth-child(odd){ background:rgba(255,255,255,.02) }
  tbody th{ text-align:left; white-space:nowrap; }

  /* WIN OVERLAY */
  .win-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(5,8,20,.55); z-index:9999; padding:16px}
  .win-card{ width:min(560px,94vw); border-radius:20px; padding:14px; border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)), #0f1428; box-shadow:0 24px 64px rgba(0,0,0,.55); position:relative; overflow:hidden}
  .win-head{ display:flex; align-items:center; gap:12px}
  .win-photo{ width:72px; height:72px; border-radius:50%; overflow:hidden; border:2px solid #4ee1a0; box-shadow:0 0 0 6px rgba(78,225,160,.25)}
  .win-photo img{ width:100%; height:100%; object-fit:cover}
  .win-name{ font-size:22px; font-weight:900}
  #confettiCanvas{ position:absolute; inset:0; pointer-events:none}
  .win-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap }
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111827;color:#e5e7eb;padding:10px 14px;border-radius:10px;border:1px solid #374151;z-index:99999;font-weight:800;letter-spacing:.2px}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="top-left">
      <span class="chip">Conga / Chinch√≥n</span>
      <span class="brand">Alanis Scorekeeper <span class="ver">STAGE v3.4</span></span>
    </div>
    <button id="openSettings" class="iconbtn" aria-label="Settings">‚öôÔ∏è</button>
  </header>

  <section class="card" style="padding:10px; margin-bottom:8px">
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <div><strong>Next dealer:</strong> <span id="nextDealerName">‚Äî</span></div>
      <div class="hint">Long-press player row to Edit (and set dealer).</div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
        <button id="lockToggle" class="iconbtn" title="Lock/unlock reordering" aria-label="Lock/unlock">üîì</button>
        <button id="historyBtn" class="btn ghost">History</button>
        <button id="newRoundBtn" class="btn primary">New round</button>
      </div>
    </div>
  </section>

  <section class="players">
    <header><div>Players</div></header>
    <div id="playersList" aria-live="polite"></div>
    <button class="btn ghost" id="addPlayerBtn" style="width:100%; margin-top:6px">+ Add player</button>
  </section>

  <section id="banner" class="banner" style="display:none" aria-live="polite">
    <div><strong id="bannerText">Game over</strong></div>
    <div class="tag">Game over</div>
    <div style="margin-left:auto; display:flex; gap:8px">
      <button class="btn success" id="newGameBtn">New game</button>
    </div>
  </section>
</div>

<!-- SETTINGS -->
<dialog id="settingsDialog" aria-labelledby="settingsTitle">
  <div class="modal-head">
    <div id="settingsTitle" style="font-weight:800">Settings</div>
    <button class="btn ghost" onclick="settingsDialog.close()">Close</button>
  </div>
  <div class="modal-body" style="display:grid; gap:14px">
    <div>
      <label for="limitInput">Limit (default 100)</label>
      <input id="limitInput" type="number" inputmode="numeric" min="1" step="1" />
    </div>
    <label class="switch">
      <input id="autoAdvance" type="checkbox" />
      <span>Auto-advance dealer after round</span>
    </label>
    <label class="switch">
      <input id="lockOrderSwitch" type="checkbox" />
      <span>Lock player reordering</span>
    </label>
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="exportBtn">Export CSV</button>
      <button class="btn ghost" id="resetScoresBtn">Reset scores</button>
      <button class="btn warn" id="clearAllBtn">Clear all</button>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn success" onclick="settingsDialog.close()">Done</button>
  </div>
</dialog>

<!-- Round dialog -->
<dialog id="roundDialog" aria-labelledby="roundTitle">
  <div class="modal-head">
    <div>
      <div id="roundTitle" style="font-weight:800">New Round</div>
      <div class="hint">Enter points (negatives OK). ‚Äú‚àí10‚Äù changes the input.</div>
    </div>
    <button class="btn ghost" onclick="roundDialog.close()">Close</button>
  </div>
  <form id="roundForm" method="dialog">
    <div class="modal-body">
      <div class="grid-rows" id="roundRows"></div>
      <div style="margin-top:8px">
        <label style="margin-bottom:6px; display:block"><strong>Who cut (cort√≥)?</strong> <span class="hint">(optional)</span></label>
        <div id="cuttersGroup" role="radiogroup" aria-label="Cutter select" style="display:flex; flex-wrap:wrap; gap:6px"></div>
      </div>
    </div>
    <div class="modal-foot">
      <div id="roundError" class="error" style="display:none"></div>
      <button type="button" class="btn ghost" onclick="roundDialog.close()">Cancel</button>
      <button id="applyRoundBtn" type="submit" class="btn success">Apply</button>
    </div>
  </form>
</dialog>

<!-- Edit player dialog -->
<dialog id="editDialog" aria-labelledby="editTitle">
  <div class="modal-head">
    <div id="editTitle" style="font-weight:800">Edit player</div>
    <button class="btn ghost" onclick="editDialog.close()">Close</button>
  </div>
  <form id="editForm" method="dialog">
    <div class="modal-body">
      <input type="hidden" id="editId" />
      <div style="display:grid; gap:10px">
        <div>
          <label for="editName">Name</label>
          <input id="editName" type="text" required />
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
          <div>
            <label for="editScore">Score</label>
            <input id="editScore" type="number" step="1" />
          </div>
          <div>
            <label for="editReeng">Reenganches</label>
            <input id="editReeng" type="number" step="1" min="0" />
          </div>
        </div>

        <div style="display:grid; gap:10px; margin-top:6px">
          <div>
            <label>Photo</label>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button type="button" class="btn" id="changePhotoBtn">Change photo</button>
              <button type="button" class="btn ghost" id="removePhotoBtn">Remove photo</button>
              <button type="button" class="btn ghost" id="viewHistoryBtn">View cut history</button>
            </div>
          </div>
          <label class="switch" style="display:flex; align-items:center; gap:10px">
            <input id="setDealerSwitch" type="checkbox">
            <span>Set as next dealer</span>
          </label>
          <div>
            <button type="button" class="btn warn" id="deletePlayerBtn">Delete player</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn ghost" type="button" onclick="editDialog.close()">Cancel</button>
      <button class="btn success" type="submit">Save</button>
    </div>
  </form>
</dialog>

<!-- Win overlay -->
<div class="win-overlay" id="winOverlay" aria-live="polite">
  <div class="win-card">
    <canvas id="confettiCanvas"></canvas>
    <div class="win-head">
      <div class="win-photo"><img id="winPhoto" alt=""></div>
      <div>
        <div class="win-name" id="winName">Winner</div>
        <div class="win-sub" id="winSubtitle">WINNER</div>
      </div>
    </div>
    <div class="win-actions">
      <button class="btn success" id="winCloseBtn">Close</button>
    </div>
  </div>
</div>

<audio id="winSound" preload="auto">
  <source type="audio/mp3"
    src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAAQAAABgAABcAAABWAAACAAACAQAAAC4AAABfAAAAdwAAAIQAAACkAAAAvwAAAN4AAAD///8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAAAgP8AAP//AP//AP8AAP//AAAAAP8AAP//AP//AP//AP//AP//AP//AAAAAAA="/>
</audio>

<!-- Crop dialog -->
<dialog id="cropDialog" aria-labelledby="cropTitle">
  <div class="modal-head">
    <div id="cropTitle" style="font-weight:800">Crop photo</div>
    <button class="btn ghost" onclick="cropDialog.close()">Close</button>
  </div>
  <div class="modal-body">
    <div class="crop-frame-hint">Drag to position. Pinch to zoom (on phone) or use slider.</div>
    <canvas id="cropCanvas" width="600" height="600" style="touch-action:none; background:#0b1225; border:1px solid rgba(255,255,255,.12); border-radius:12px"></canvas>
    <div class="crop-controls" style="display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px;">
      <input id="cropZoom" type="range" min="0.6" max="3" step="0.01" value="1" style="flex:1">
      <button class="btn" id="cropReset">Reset</button>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn ghost" onclick="cropDialog.close()">Cancel</button>
    <button class="btn success" id="cropSave">Save</button>
  </div>
</dialog>

<!-- Cut history dialog -->
<dialog id="historyDialog" aria-labelledby="historyTitle">
  <div class="modal-head">
    <div id="historyTitle" style="font-weight:800">Cut history</div>
    <button class="btn ghost" onclick="historyDialog.close()">Close</button>
  </div>
  <div class="modal-body">
    <div class="history-list" id="historyList" style="display:grid; gap:8px; max-height:50vh; overflow:auto;"></div>
  </div>
</dialog>

<!-- Rounds history dialog -->
<dialog id="roundsDialog" aria-labelledby="roundsTitle">
  <div class="modal-head">
    <div id="roundsTitle" style="font-weight:800">Rounds history</div>
    <button class="btn ghost" onclick="roundsDialog.close()">Close</button>
  </div>
  <div class="modal-body">
    <div class="table-wrap"><div id="roundsTableWrap"></div></div>
  </div>
</dialog>

<!-- Player row template -->
<template id="playerRowTpl">
  <div class="row" draggable="true" aria-grabbed="false" title="Long-press to Edit">
    <div class="drag" aria-hidden="true">‚â°</div>
    <div class="avatar" aria-hidden="true"><span class="initials">P</span></div>
    <strong class="playerName">Player</strong>
    <div class="scorewrap">
      <span class="stars" aria-label="Reenganches"></span>
      <span class="score" aria-label="Score"><span class="scoreVal">0</span></span>
    </div>
  </div>
</template>

<input id="photoInput" type="file" accept="image/*" hidden>
<input id="importJsonInput" type="file" accept="application/json" hidden>

<script>
/* === STAGE v3.4 (Prod UI + latest rule fixes + iOS zoom guard + working cropper) === */
(() => {
  "use strict";
  const $ = s => document.querySelector(s);
  const bind = (sel, prop, fn) => { const el = $(sel); if (el) el[prop] = fn; };
  const on = (sel, ev, fn, opt) => { const el = $(sel); if (el) el.addEventListener(ev, fn, opt||false); };
  const uid=()=> "p"+Math.random().toString(36).slice(2)+Date.now().toString(36);
  const clampInt=(v,d=0)=>Number.isFinite(+v)?Math.trunc(+v):d;
  const initials=(n)=> (n||" ").trim().split(/\s+/).map(s=>s[0]).join("").slice(0,2).toUpperCase();
  const csv=s=>(/[",\n]/.test(s)?'"'+String(s).replace(/"/g,'""')+'"':String(s));
  const todayStr=()=> new Date().toISOString().slice(0,10);
  const toast = (m)=>{ const t=document.createElement('div'); t.className='toast'; t.textContent=m; document.body.appendChild(t); setTimeout(()=>t.remove(),1400); };

  // Viewport zoom control (prevents iOS auto zoom when dialogs open)
  const vp = document.querySelector('meta[name="viewport"]');
  const VP_BASE = 'width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=5';
  function disableAutoZoom(){ try{ if(!vp) return; vp.setAttribute('content','width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1'); }catch{} }
  function restoreZoom(){ try{ if(!vp) return; vp.setAttribute('content', VP_BASE); }catch{} }
  const pulseNoZoom = ()=>{ disableAutoZoom(); setTimeout(restoreZoom, 160); };

  // Storage
  const storageKey="conga_state_stage_v34";
  let players=[], limit=100, nextDealerId=null, autoAdvanceDealer=true, gameOver=false;
  let cutsHistory=[]; let roundCounter=0; let rounds=[]; let winsLog=[]; let lockOrder=false;
  const pruneWins=()=>{ const cutoff=Date.now()-7*24*3600*1000; winsLog = (winsLog||[]).filter(w=>w.timestamp>=cutoff); };
  const save=()=>{ localStorage.setItem(storageKey, JSON.stringify({players,limit,nextDealerId,autoAdvanceDealer,gameOver,cutsHistory,roundCounter,rounds,winsLog,lockOrder})); };
  const load=()=>{ try{ const s=JSON.parse(localStorage.getItem(storageKey)||"{}");
      players = Array.isArray(s.players)? s.players : [];
      limit = Number.isFinite(s.limit)? s.limit : 100;
      autoAdvanceDealer = typeof s.autoAdvanceDealer==="boolean" ? s.autoAdvanceDealer : true;
      nextDealerId = typeof s.nextDealerId==="string" ? s.nextDealerId : (players[0]? players[0].id : null);
      gameOver = !!s.gameOver;
      cutsHistory = Array.isArray(s.cutsHistory)? s.cutsHistory : [];
      roundCounter = Number.isFinite(s.roundCounter)? s.roundCounter : 0;
      rounds = Array.isArray(s.rounds)? s.rounds : [];
      winsLog = Array.isArray(s.winsLog)? s.winsLog : [];
      lockOrder = !!s.lockOrder; pruneWins();
    }catch(e){ players=[]; } };

  // Render
  const list=$("#playersList"), rowTpl=$("#playerRowTpl");
  function render(){
    const limitInput=$("#limitInput"); if(limitInput) limitInput.value=limit;
    const autoAdv=$("#autoAdvance"); if(autoAdv) autoAdv.checked=autoAdvanceDealer;
    const lockSwitch=$("#lockOrderSwitch"); if(lockSwitch) lockSwitch.checked=lockOrder;

    const nd=$("#nextDealerName"); if(nd){ const p=players.find(p=>p.id===nextDealerId); nd.textContent=p?(p.name||"‚Äî"):"‚Äî"; }
    const banner=$("#banner"); if(banner) banner.style.display=gameOver?"":"none";
    const lockBtn=$("#lockToggle"); if(lockBtn){ lockBtn.textContent = lockOrder ? "üîí" : "üîì"; lockBtn.title = lockOrder ? "Unlock player order" : "Lock player order"; lockBtn.setAttribute("aria-label", lockBtn.title); }

    if(list) list.innerHTML="";
    for(let i=0;i<players.length;i++){
      const p=players[i]; const n=rowTpl.content.firstElementChild.cloneNode(true);
      n.dataset.index=i; n.dataset.id=p.id; n.draggable=!lockOrder;
      if(!lockOrder){ n.addEventListener("dragstart",dragStart); n.addEventListener("dragover",dragOver); n.addEventListener("drop",drop); n.addEventListener("dragend",dragEnd); }
      attachLongPress(n, ()=>openEdit(p.id));
      if(p.id===nextDealerId) n.classList.add("dealer");
      const avatarBox=n.querySelector(".avatar");
      if(avatarBox){ avatarBox.innerHTML = p.avatar ? `<img alt="" src="${p.avatar}">` : `<span class="initials">${initials(p.name||"")}</span>`; }
      n.querySelector(".playerName").textContent=p.name||"‚Äî";
      const r=clampInt(p.reenganches||0,0); n.querySelector(".stars").textContent = r>0 ? (r===1?"‚òÖ":"‚òÖ "+r) : "";
      const sv=n.querySelector(".scoreVal"); sv.textContent=clampInt(p.score||0);
      const sc=n.querySelector(".score"); if((p.score||0)>=limit+1) sc.classList.add("over"); else sc.classList.remove("over");
      const handle=n.querySelector(".drag"); if(lockOrder){ handle.classList.add("locked"); handle.onclick=()=>toast("Order locked"); } else { handle.classList.remove("locked"); handle.onclick=null; }
      list && list.appendChild(n);
    }
    const nr=$("#newRoundBtn"); if(nr) nr.disabled=players.length===0||gameOver;
    save();
  }

  function attachLongPress(el, cb){
    let tmr, moved=false;
    const start = ()=>{ moved=false; tmr=setTimeout(()=>{ if(!moved) cb(); },600); };
    const end = ()=>{ clearTimeout(tmr); };
    el.addEventListener('touchstart', start, {passive:true});
    el.addEventListener('mousedown', start);
    el.addEventListener('touchmove', ()=>{ moved=true; }, {passive:true});
    ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>el.addEventListener(ev, end));
  }

  // Drag & drop
  let dragIdx=null; const dragStart=e=>{dragIdx=+e.currentTarget.dataset.index; e.dataTransfer.effectAllowed="move"; e.dataTransfer.setData("text/plain", String(dragIdx)); e.currentTarget.setAttribute("aria-grabbed","true");};
  const dragOver=e=>{e.preventDefault(); e.dataTransfer.dropEffect="move";};
  const drop=e=>{e.preventDefault(); const from=dragIdx!=null?dragIdx:+e.dataTransfer.getData("text/plain"); const to=+e.currentTarget.dataset.index; if(Number.isInteger(from)&&Number.isInteger(to)&&from!==to){ const arr=players.slice(); const m=arr.splice(from,1)[0]; arr.splice(to,0,m); const keep=nextDealerId; players=arr; nextDealerId=keep; render(); }};
  const dragEnd=e=>{e.currentTarget.setAttribute("aria-grabbed","false"); dragIdx=null;};

  // Edit dialog
  const editDlg=$("#editDialog"), editForm=$("#editForm"), photoInput=$("#photoInput");
  function openEdit(id){ const p=players.find(x=>x.id===id); if(!p) return;
    $("#editId").value=p.id; $("#editName").value=p.name||""; $("#editScore").value=clampInt(p.score||0); $("#editReeng").value=clampInt(p.reenganches||0);
    const sds=$("#setDealerSwitch"); if(sds) sds.checked=(p.id===nextDealerId);
    bind("#changePhotoBtn","onclick", ()=>{ if(photoInput){ window._photoTarget=p.id; photoInput.value=""; photoInput.click(); }});
    bind("#removePhotoBtn","onclick", ()=>{ p.avatar=null; render(); });
    bind("#viewHistoryBtn","onclick", ()=> openHistory(p.id));
    bind("#deletePlayerBtn","onclick", ()=>{ if(confirm("Delete this player? This cannot be undone.")){ editDlg.close(); removePlayer(p.id); }});
    editDlg && editDlg.showModal(); pulseNoZoom();
  }
  if(editForm) editForm.addEventListener("submit", (e)=>{
    e.preventDefault(); const id=$("#editId").value; const p=players.find(x=>x.id===id); if(!p) return editDlg && editDlg.close();
    p.name=String($("#editName").value||"").trim()||p.name; p.score=clampInt($("#editScore").value, p.score); p.reenganches=Math.max(0, clampInt($("#editReeng").value, p.reenganches));
    const sds=$("#setDealerSwitch"); if(sds && sds.checked) nextDealerId=p.id; editDlg && editDlg.close(); render();
  });

  // Photo input -> cropper
  if(photoInput){ photoInput.removeAttribute('capture'); photoInput.addEventListener("change", async()=>{ if(!window._photoTarget || !photoInput.files || !photoInput.files[0]) return; const file=photoInput.files[0]; const dataUrl=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); openCropper(dataUrl, window._photoTarget); window._photoTarget=null; }); }

  // Round dialog
  const roundDlg=$("#roundDialog"), rows=$("#roundRows"), cutters=$("#cuttersGroup"), rErr=$("#roundError"), applyBtn=$("#applyRoundBtn");
  const openRound=()=>{ if(!roundDlg||!rows||!cutters) return; rows.innerHTML=""; cutters.innerHTML="";
    players.forEach(p=>{ const r=document.createElement("div"); r.className="round-row";
      const name=document.createElement("div"); name.innerHTML=`<strong>${p.name}</strong><div class=\"hint\">Current: ${p.score||0}</div>`;
      const inp=document.createElement("input"); inp.id="rr_"+p.id; inp.type="number"; inp.step="1"; inp.inputMode="numeric"; inp.placeholder="0"; inp.dataset.pid=p.id; inp.addEventListener("input", validateRound);
      const minus=document.createElement("button"); minus.type="button"; minus.className="minus10"; minus.textContent="‚àí10"; minus.onclick=()=>{ inp.value=clampInt((inp.value===""?0:+inp.value)-10); validateRound(); };
      const cut=document.createElement("div"); cut.className="r-cutter"; cut.innerHTML=`<input type=\"radio\" name=\"cutter\" value=\"${p.id}\" aria-label=\"Cutter ${p.name}\">`;
      cut.querySelector("input").addEventListener("change", validateRound);
      r.append(name,inp,minus,cut); rows.appendChild(r);
      const chip=document.createElement("label"); chip.style.cssText="display:inline-flex;align-items:center;gap:8px;border:1px dashed rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;cursor:pointer;"; chip.innerHTML=`<input class=\"visually-hidden\" type=\"radio\" name=\"cutter\" value=\"${p.id}\"><span>‚úÇÔ∏è ${p.name}</span>`; chip.querySelector("input").addEventListener("change", validateRound); cutters.appendChild(chip);
    });
    const none=document.createElement("label"); none.style.cssText="display:inline-flex;align-items:center;gap:8px;border:1px dashed rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;cursor:pointer;"; none.innerHTML=`<input class=\"visually-hidden\" type=\"radio\" name=\"cutter\" value=\"\" checked><span>‚Äî</span>`; none.querySelector("input").addEventListener("change", validateRound); cutters.insertBefore(none, cutters.firstChild);
    if(rErr) rErr.style.display="none"; if(applyBtn) applyBtn.disabled=false; roundDlg.showModal(); pulseNoZoom();
  };
  const roundInputs=()=>{ const m={}; for(const p of players){ const el=$("#rr_"+p.id); m[p.id]=clampInt(el && el.value!=="" ? el.value : 0,0);} return m; };
  const selectedCutter=()=>{ const sel=document.querySelector('input[name="cutter"]:checked'); const v=sel?sel.value:""; return v||null; };
  function validateRound(){ const inputs=roundInputs(); const cid=selectedCutter(); if(!cid){ if(rErr) rErr.style.display="none"; if(applyBtn) applyBtn.disabled=false; return true; } const c=players.find(p=>p.id===cid); if(!c){ if(rErr){ rErr.textContent="Invalid cutter selected."; rErr.style.display=""; } if(applyBtn) applyBtn.disabled=true; return false; } const proj=clampInt(c.score||0)+clampInt(inputs[c.id]||0); if(proj>limit){ if(rErr){ rErr.textContent=`Cutter cannot exceed ${limit}. (Projected: ${proj})`; rErr.style.display=""; } if(applyBtn) applyBtn.disabled=true; return false; } if(rErr) rErr.style.display="none"; if(applyBtn) applyBtn.disabled=false; return true; }

  function snapshotTotalsById(){ const o={}; for(const p of players) o[p.id]=clampInt(p.score||0); return o; }
  function applyRound(inputs,cid){
    const snapshotInputs = JSON.parse(JSON.stringify(inputs));
    const roundNo = roundCounter + 1;
    const proj=new Map(); players.forEach(p=>proj.set(p.id, clampInt(p.score||0)+clampInt(inputs[p.id]||0)));
    roundCounter += 1;
    if (cid){ const cutter = players.find(p=>p.id===cid); cutsHistory.push({ id: cid, name: cutter? (cutter.name||"‚Äî") : "‚Äî", round: roundCounter, timestamp: Date.now(), result: "played" }); }

    const under = players.filter(p => (proj.get(p.id) <= limit));
    const over  = players.filter(p => (proj.get(p.id) >= (limit+1)));

    // Instant-win: cutter ‚â§ limit and everyone else > limit
    if (cid){
      const cutterVal = proj.get(cid);
      const othersOk = players.filter(p=>p.id!==cid).every(p=> proj.get(p.id) > limit);
      if (cutterVal <= limit && othersOk){
        players.forEach(p=>{ p.score = proj.get(p.id); });
        gameOver = true; const winner = players.find(p=>p.id===cid);
        winsLog.push({ playerId:winner.id, name:winner.name, date:todayStr(), timestamp:Date.now() }); pruneWins();
        const last = cutsHistory.slice().reverse().find(h => h.round===roundCounter && h.id===cid); if (last) last.result = "cut_win";
        rounds.push({round:roundNo, inputs:snapshotInputs, totals:snapshotTotalsById(), cutterId:cid, timestamp:Date.now()});
        roundDlg && roundDlg.close(); showWinOverlay(winner); save(); render(); return;
      }
    }

    // Reenganche ONLY at == limit+1 => set to max‚â§limit
    if (under.length >= 2 && over.length){
      const maxUnderVal = Math.max.apply(null, under.map(p => proj.get(p.id)));
      players.forEach(p=>{
        let val = proj.get(p.id);
        if (val >= (limit+1)){
          proj.set(p.id, maxUnderVal);
          p.reenganches = (p.reenganches||0) + 1;
        }
      });
    }

    players.forEach(p=>{ p.score=proj.get(p.id); });

    // Dealer auto-advance (kept by id if reordered)
    if(autoAdvanceDealer){ if(players.length && nextDealerId){ const i=players.findIndex(p=>p.id===nextDealerId); nextDealerId=players[(i>=0&&i<players.length-1)?i+1:0].id; } }

    if (cid){ const last = cutsHistory.slice().reverse().find(h => h.round===roundCounter && h.id===cid); if (last && last.result==="played") last.result="normal"; }
    rounds.push({round:roundNo, inputs:snapshotInputs, totals:snapshotTotalsById(), cutterId:cid, timestamp:Date.now()});
    gameOver=false; render();
  }

  // Dialog submit
  if($("#roundForm")) $("#roundForm").addEventListener("submit", (e)=>{ e.preventDefault(); if(!validateRound()) return; applyRound(roundInputs(), selectedCutter()); roundDlg && roundDlg.close(); });

  const exportCSV=()=>{ const header=["name","score","reenganches","isDealer"]; const rows=players.map(p=>[csv(p.name||""), String(clampInt(p.score||0)), String(clampInt(p.reenganches||0)), String(p.id===nextDealerId)]); const all=[header].concat(rows).map(r=>r.join(",")).join("\n"); const blob=new Blob(["\ufeff",all],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="conga_scores.csv"; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); };

  function openHistory(id){ const list=$("#historyList"); if(!list) return; list.innerHTML=""; const my=(cutsHistory||[]).filter(h=>h.id===id).sort((a,b)=>a.round-b.round); if(my.length===0){ list.innerHTML='<div class="history-item">No cuts recorded.</div>'; } else { for(const h of my){ const d=new Date(h.timestamp); const label=h.result==='cut_win'?'‚úÇÔ∏èüèÜ Cut win':(h.result==='normal'?'‚úÇÔ∏è Cut (no win)':'‚úÇÔ∏è Cut'); const row=document.createElement('div'); row.className='history-item'; row.textContent=`R${h.round} ‚Ä¢ ${label} ‚Ä¢ ${d.toLocaleString()}`; list.appendChild(row); } } $("#historyDialog") && $("#historyDialog").showModal(); }

  function openRoundsTable(){ const wrap=$("#roundsTableWrap"); if(!wrap) return; wrap.innerHTML=""; if(!rounds.length){ wrap.innerHTML='<div class="history-item">No rounds yet.</div>'; $("#roundsDialog") && $("#roundsDialog").showModal(); return; } const table=document.createElement('table'); const colWidth=110; const totalW = 32 + Math.max(4, players.length) * colWidth; table.style.width=Math.max(520,totalW)+"px"; const thead=document.createElement('thead'); const trh=document.createElement('tr'); const th0=document.createElement('th'); th0.textContent="#"; trh.appendChild(th0); players.forEach(p=>{ const th=document.createElement('th'); th.textContent=p.name; trh.appendChild(th); }); thead.appendChild(trh); table.appendChild(thead); const tbody=document.createElement('tbody'); rounds.forEach(r=>{ const tr=document.createElement('tr'); const th=document.createElement('th'); th.textContent=String(r.round); tr.appendChild(th); const showTotals = r.totals && typeof r.totals === 'object'; players.forEach(p=>{ const td=document.createElement('td'); const v=showTotals ? r.totals[p.id] : r.inputs[p.id]; td.textContent=Number.isFinite(v)?v:""; tr.appendChild(td); }); tbody.appendChild(tr); }); table.appendChild(tbody); wrap.appendChild(table); $("#roundsDialog") && $("#roundsDialog").showModal(); }

  // Wire-up
  bind("#openSettings","onclick", ()=> { $("#settingsDialog")?.showModal(); pulseNoZoom(); });
  bind("#historyBtn","onclick", openRoundsTable);
  bind("#newRoundBtn","onclick", openRound);
  bind("#addPlayerBtn","onclick", ()=>{ const name=prompt("Player name?"); if(name!==null){ addPlayer(String(name).trim()||undefined); } });
  bind("#exportBtn","onclick", exportCSV);
  bind("#resetScoresBtn","onclick", ()=>{ if(players.length&&confirm("Reset all scores and reenganches?")){ players.forEach(p=>{p.score=0;p.reenganches=0;}); gameOver=false; render(); } });
  bind("#clearAllBtn","onclick", ()=>{ if(confirm("Clear all players and settings?")){ players=[]; limit=100; nextDealerId=null; autoAdvanceDealer=true; gameOver=false; cutsHistory=[]; rounds=[]; roundCounter=0; winsLog=[]; render(); } });
  bind("#newGameBtn","onclick", ()=>{ players.forEach(p=>{p.score=0;p.reenganches=0;}); gameOver=false; rounds=[]; roundCounter=0; render(); window.scrollTo({top:0,behavior:"smooth"}); });
  bind("#lockToggle","onclick", ()=>{ lockOrder=!lockOrder; const sw=$("#lockOrderSwitch"); if(sw) sw.checked=lockOrder; render(); });
  on("#lockOrderSwitch","change", e=>{ lockOrder=!!e.target.checked; render(); });
  on("#limitInput","input", e=>{ const v=clampInt(e.target.value,limit); limit=Math.max(1,v); render(); });
  on("#autoAdvance","change", e=>{ autoAdvanceDealer=!!e.target.checked; render(); });

  // helpers
  const addPlayer=(name="")=>{ const p={id:uid(), name:name||("Player "+(players.length+1)), score:0, reenganches:0, avatar:null}; players.push(p); if(!nextDealerId && players[0]) nextDealerId=players[0].id; gameOver=false; render(); };
  const removePlayer=id=>{ const i=players.findIndex(p=>p.id===id); if(i<0) return; const was=players[i].id===nextDealerId; players.splice(i,1); if(!players.length) nextDealerId=null; else if(was) nextDealerId=players[Math.min(i,players.length-1)].id; render(); };

  // Win overlay (simple)
  function showWinOverlay(winner){ const ov=document.getElementById('winOverlay'); if(!ov) return; document.getElementById('winName').textContent = winner?.name || 'Winner'; document.getElementById('winSubtitle').textContent = 'Instant win'; ov.style.display='flex'; try{ document.getElementById('winSound').play().catch(()=>{});}catch{} startConfetti(); }
  document.getElementById('winCloseBtn')?.addEventListener('click', ()=>{ document.getElementById('winOverlay').style.display='none'; });

  // Confetti
  function startConfetti(){ const c=document.getElementById('confettiCanvas'); if(!c) return; const ctx=c.getContext('2d'); const DPR=window.devicePixelRatio||1; const W=c.parentElement.clientWidth, H=c.parentElement.clientHeight; c.width=W*DPR; c.height=H*DPR; ctx.scale(DPR,DPR); const pieces=Array.from({length:200},()=>({x:Math.random()*W, y:-10-Math.random()*H, r:2+Math.random()*4, vy:2+Math.random()*3, vx:-1+Math.random()*2, a:Math.random()*Math.PI*2})); let raf; const tick=()=>{ ctx.clearRect(0,0,W,H); pieces.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.a+=0.1; if(p.y>H+20){ p.y=-20; p.x=Math.random()*W; } ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=`hsl(${Math.floor(Math.random()*360)},90%,60%)`; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore(); }); raf=requestAnimationFrame(tick); }; cancelAnimationFrame(raf); tick(); }

  // ===== Image Cropper =====
  function openCropper(dataUrl, targetId){
    const dlg = $('#cropDialog'); const cvs = $('#cropCanvas'); const zoom = $('#cropZoom'); const resetBtn = $('#cropReset'); const saveBtn = $('#cropSave');
    if(!dlg || !cvs || !zoom || !saveBtn) return;
    const ctx = cvs.getContext('2d'); let img = new Image(); let scale=1, minScale=1; let offX=0, offY=0; let dragging=false, startX=0, startY=0; let pinch=false, pinchStartDist=0, pinchStartScale=1;

    function draw(){ ctx.clearRect(0,0,cvs.width,cvs.height); // dark backdrop
      ctx.save(); ctx.translate(cvs.width/2 + offX, cvs.height/2 + offY); ctx.scale(scale, scale); ctx.drawImage(img, -img.width/2, -img.height/2); ctx.restore();
      // circular preview mask (optional): leaving square for consistency with avatar
    }
    function clamp(){ // keep image covering canvas
      const w = img.width*scale, h = img.height*scale; const maxX = Math.max(0,(w-cvs.width)/2); const maxY = Math.max(0,(h-cvs.height)/2); offX = Math.min(maxX, Math.max(-maxX, offX)); offY = Math.min(maxY, Math.max(-maxY, offY)); }

    img.onload = ()=>{ const sx = cvs.width / img.width; const sy = cvs.height / img.height; minScale = Math.max(sx, sy); scale = minScale; zoom.min = String(Math.max(0.6, Math.round(minScale*100)/100)); zoom.value = String(scale); offX=0; offY=0; clamp(); draw(); };
    img.src = dataUrl;

    // Pointer pan
    cvs.addEventListener('pointerdown', e=>{ dragging=true; startX=e.clientX; startY=e.clientY; cvs.setPointerCapture(e.pointerId); });
    cvs.addEventListener('pointermove', e=>{ if(!dragging) return; offX += (e.clientX-startX); offY += (e.clientY-startY); startX=e.clientX; startY=e.clientY; clamp(); draw(); });
    cvs.addEventListener('pointerup', e=>{ dragging=false; cvs.releasePointerCapture(e.pointerId); });
    cvs.addEventListener('pointercancel', ()=> dragging=false);

    // Touch pinch zoom
    cvs.addEventListener('touchstart', (e)=>{ if(e.touches.length===2){ pinch=true; pinchStartDist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); pinchStartScale = scale; } }, {passive:false});
    cvs.addEventListener('touchmove', (e)=>{
      if(pinch && e.touches.length===2){
        e.preventDefault();
        const dist = Math.hypot(
          e.touches[0].clientX-e.touches[1].clientX,
          e.touches[0].clientY-e.touches[1].clientY
        );
        const next = pinchStartScale * (dist / pinchStartDist);
        scale = Math.min(3, Math.max(minScale, next));
        zoom.value = String(scale);
        clamp(); draw();
      }
    }, {passive:false});
    cvs.addEventListener('touchend', ()=>{ pinch=false; }, {passive:true});

    // Wheel zoom (desktop)
    const onWheel = (e)=>{
      e.preventDefault();
      const factor = e.deltaY > 0 ? 0.95 : 1.05;
      const next = scale * factor;
      scale = Math.min(3, Math.max(minScale, next));
      zoom.value = String(scale);
      clamp(); draw();
    };
    cvs.addEventListener('wheel', onWheel, {passive:false});

    // Slider zoom
    const onZoom = ()=>{
      const val = parseFloat(zoom.value || String(scale));
      scale = Math.min(3, Math.max(minScale, val));
      clamp(); draw();
    };
    zoom.addEventListener('input', onZoom);

    // Reset
    const onReset = ()=>{
      scale = minScale; offX = 0; offY = 0;
      zoom.value = String(scale);
      clamp(); draw();
    };
    resetBtn?.addEventListener('click', onReset);

    // Save -> write avatar
    const onSave = ()=>{
      const out = document.createElement('canvas');
      out.width = 512; out.height = 512;
      const k = out.width / cvs.width; // scale offsets to target canvas size
      const octx = out.getContext('2d');
      octx.fillStyle = '#0b1225';
      octx.fillRect(0,0,out.width,out.height);
      octx.translate(out.width/2 + offX*k, out.height/2 + offY*k);
      octx.scale(scale, scale);
      octx.drawImage(img, -img.width/2, -img.height/2);
      const dataOut = out.toDataURL('image/png', 0.92);

      const p = players.find(x=>x.id===targetId);
      if (p){ p.avatar = dataOut; render(); save(); }
      cleanup();
      dlg.close();
    };
    saveBtn.addEventListener('click', onSave);

    // Cleanup listeners when dialog closes
    function cleanup(){
      cvs.removeEventListener('pointerdown', pointerDown);
      cvs.removeEventListener('pointermove', pointerMove);
      cvs.removeEventListener('pointerup', pointerUp);
      cvs.removeEventListener('pointercancel', pointerCancel);
      cvs.removeEventListener('touchstart', tstart);
      cvs.removeEventListener('touchmove', tmove);
      cvs.removeEventListener('touchend', tend);
      cvs.removeEventListener('wheel', onWheel);
      zoom.removeEventListener('input', onZoom);
      resetBtn?.removeEventListener('click', onReset);
      saveBtn.removeEventListener('click', onSave);
    }

    // Keep named refs for cleanup
    function pointerDown(e){ dragging=true; startX=e.clientX; startY=e.clientY; cvs.setPointerCapture(e.pointerId); }
    function pointerMove(e){ if(!dragging) return; offX += (e.clientX-startX); offY += (e.clientY-startY); startX=e.clientX; startY=e.clientY; clamp(); draw(); }
    function pointerUp(e){ dragging=false; try{ cvs.releasePointerCapture(e.pointerId); }catch{} }
    function pointerCancel(){ dragging=false; }
    function tstart(e){ if(e.touches.length===2){ pinch=true; pinchStartDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); pinchStartScale=scale; } }
    function tmove(e){
      if(pinch && e.touches.length===2){
        e.preventDefault();
        const dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
        const next = pinchStartScale * (dist/pinchStartDist);
        scale = Math.min(3, Math.max(minScale, next));
        zoom.value = String(scale);
        clamp(); draw();
      }
    }
    function tend(){ pinch=false; }

    // Attach pointer handlers
    cvs.addEventListener('pointerdown', pointerDown);
    cvs.addEventListener('pointermove', pointerMove);
    cvs.addEventListener('pointerup', pointerUp);
    cvs.addEventListener('pointercancel', pointerCancel);
    cvs.addEventListener('touchstart', tstart, {passive:false});
    cvs.addEventListener('touchmove', tmove, {passive:false});
    cvs.addEventListener('touchend', tend, {passive:true});

    dlg.addEventListener('close', cleanup, {once:true});
    dlg.showModal(); pulseNoZoom();
  }
  // ===== end cropper =====

  // Init
  load();
  render();
})();
</script>
</body>
</html>
```
