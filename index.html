<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Conga by Alanis ‚Äî STAGE v3.7.6</title>
<meta name="theme-color" content="#0f1220" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.webmanifest">

<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --muted:#2a2f4a; --text:#e8ecff; --sub:#b8c0ff;
    --accent:#7aa2ff; --accent-2:#4ee1a0; --danger:#ff6b6b; --warn:#ffb020;
    --shadow: 0 8px 24px rgba(0,0,0,.35); --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, sans-serif;
    background: radial-gradient(1200px 800px at 20% -10%, #162040, #0d1020 60%) fixed, var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    line-height:1.35;
    -webkit-tap-highlight-color: transparent;

    /* Keep the page itself non-scrollable. Only the Players pane scrolls. */
    min-height: 100svh;
    overflow: hidden;
  }

  /* Shell fills the viewport; header + tools stay, players scroll */
  .app{
    max-width:980px; margin:0 auto;
    height:100%; min-height:100svh;
    padding:6px 12px;
    display:flex; flex-direction:column;
  }

  /* ===== Header (fixed in layout) ===== */
  header{
    display:grid;
    grid-template-columns: 1fr auto auto;
    align-items:center;
    gap:10px;
    padding:6px 0 2px 0;
  }
  .brand{display:flex; flex-direction:column; gap:2px}
  .title{font-weight:900; letter-spacing:.2px; font-size: clamp(18px, 5vw, 26px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .ver{font-weight:800; font-size:12px; color:var(--sub); opacity:.9}
  .lang-pill{display:inline-flex; gap:8px; align-items:center; border:1px dashed rgba(255,255,255,.18); border-radius:999px; padding:6px 10px; height:36px; font-weight:800}
  .lang-pill button{appearance:none; background:none; border:0; color:inherit; font:inherit; cursor:pointer; opacity:.85}
  .lang-pill .active{opacity:1; text-decoration:underline}
  .iconbtn{width:40px; height:40px; display:grid; place-items:center; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:#0f1428; color:var(--text); cursor:pointer; font-size:18px}

  /* ===== Tools card (fixed in layout) ===== */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)) , var(--card);
    border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow);
    padding:10px; margin:8px 0;
  }
  .tools{display:flex; gap:8px; align-items:center; white-space:nowrap}
  .btn{appearance:none; border:0; cursor:pointer; user-select:none; padding:10px 12px; border-radius:12px;
    background: linear-gradient(135deg, #1a2344, #121a34); border:1px dashed rgba(255,255,255,.22);
    color:var(--text); font-weight:900; letter-spacing:.2px; transition:.15s; flex:1 1 0; min-width:0; white-space:nowrap; font-size: clamp(12px, 3.4vw, 16px)}
  .btn:hover{filter:brightness(1.07)} .btn:active{transform:translateY(1px)}
  .btn.primary{background: linear-gradient(135deg, var(--accent), #9f7cff); color:#0b0f1f; border-style:solid}
  .btn.success{background: linear-gradient(135deg, var(--accent-2), #9cffc8); color:#001c12; border-style:solid}
  #dealerLine{margin-top:6px; font-weight:800; color:var(--sub); font-size:12px}

  /* ===== Players panel (ONLY this scrolls) ===== */
  .players-pane{
    flex:1 1 auto;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    padding-bottom: calc(16px + env(safe-area-inset-bottom));
  }

  .players header{ margin:6px 0 6px 2px; color:var(--sub); font-size:12px; }
  .players, .players *{ user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; }

  .row{
    display:grid; grid-template-columns: 28px 44px 1fr auto;
    align-items:center; gap:10px; padding:10px; border-radius:14px;
    border:1px solid rgba(255,255,255,.06);
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    margin-bottom:8px; position:relative
  }
  .row.dealer{ border-color: rgba(78,225,160,.6); box-shadow: 0 0 0 2px rgba(78,225,160,.25) inset, 0 0 0 2px rgba(78,225,160,.15); }
  .drag{ cursor:grab; text-align:center; font-size:18px; color:var(--sub); touch-action:none; }
  .drag.locked{ filter:grayscale(1); opacity:.5; cursor:not-allowed }
  .avatar{ width:40px; height:40px; border-radius:50%; display:grid; place-items:center; background:#0f1428; border:1px solid rgba(255,255,255,.14); overflow:hidden; font-weight:800; font-size:14px;}
  .row.dealer .avatar{ box-shadow: 0 0 0 3px #4ee1a0, 0 0 0 6px rgba(78,225,160,.25), 0 0 12px rgba(78,225,160,.35); }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .playerName{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; line-height:1.1; font-size:20px; font-weight:900; }
  .scorewrap{ display:flex; align-items:center; gap:8px; min-width:86px; justify-content:flex-end; }
  .stars{ color:var(--danger); font-weight:900; font-size:16px; white-space:nowrap; margin-right:2px }
  .score{ font-variant-numeric: tabular-nums; font-weight:900; text-align:right; font-size:22px; }
  .score.over{ color:var(--danger) }

  /* Live drag visuals */
  .row.placeholder{
    background: repeating-linear-gradient(-45deg, rgba(78,225,160,.12), rgba(78,225,160,.12) 6px, transparent 6px, transparent 12px);
    border:2px dashed rgba(78,225,160,.55);
    box-shadow: inset 0 0 0 2px rgba(78,225,160,.25);
  }
  .drag-ghost{
    position:fixed; left:0; top:0; z-index:9999; pointer-events:none;
    transform: translate3d(0,0,0);
    box-shadow: 0 14px 30px rgba(0,0,0,.45);
    opacity:.98;
  }

  /* Dialogs / inputs */
  dialog{ width:min(720px, 96vw); border-radius:16px; border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)) , #0f1428; color:var(--text);
    box-shadow: 0 24px 64px rgba(0,0,0,.55); overflow:hidden }
  dialog::backdrop{ background: rgba(2,6,23,.55) }
  .modal-head{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between; gap:10px }
  .modal-body{ padding:12px 14px; max-height:70vh; overflow:auto; overscroll-behavior:contain }
  .modal-foot{ padding:12px 14px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap }
  label{font-size:12px; color:var(--sub); display:block; margin-bottom:6px}
  input[type="number"], input[type="text"], select{width:100%; background:#0f1428; border:1px solid var(--muted);
    color:var(--text); padding:9px 10px; border-radius:12px; outline:none; height:38px;}
  input, select, textarea, button { font-size:16px; } /* iOS zoom guard */
  dialog .btn { border-style: solid; }

  .switch { position: relative; display: grid; grid-template-columns: 44px 1fr; align-items: center; gap: 10px; }
  .switch input { position: absolute; opacity: 0; width: 0; height: 0; }
  .switch .track { width: 40px; height: 20px; background: var(--muted); border-radius: 999px; transition: .15s; }
  .switch .thumb { position: absolute; width: 18px; height: 18px; left: 1px; top: 1px; border-radius: 50%; background: var(--text); transition: .15s; }
  .switch input:checked + .track { background: var(--accent); }
  .switch input:checked + .track + .thumb { transform: translateX(20px); }
  .switch .switch-label { font-size: 14px; color: var(--text); }

  .grid-rows{ display:grid; gap:4px }
  .round-row{ display:grid; grid-template-columns: auto 100px 50px; gap:6px; align-items:center;
    padding:4px; border:1px dashed rgba(255,255,255,.15); border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); }
  .round-row > div:first-child { display: flex; flex-direction: column; font-size: 14px; }
  .round-row strong { font-size: 16px; }
  .round-row .hint { font-size: 11px; color: var(--sub); }
  .round-row input[type="number"]{ height:30px; padding:4px 8px; font-size:14px; }
  .round-row .minus10{ width:100%; height:30px; border-radius:8px; border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(135deg, #1c243e, #121a34); color:var(--text); font-weight:800; padding:0 2px; font-size:14px; }
  .error{ color:var(--danger); font-weight:700; margin-right:auto }

  /* Circular cropper */
  #cropDialog { width: min(460px, 92vw); }
  #cropStage { position: relative; width: 100%; height: 360px; border-radius: 16px; background:#0b0f20; border:1px solid rgba(255,255,255,.1); overflow:hidden; touch-action:none; }
  #cropCanvas { position:absolute; inset:0; width:100%; height:100%; }
  .crop-controls { display:grid; gap:10px; padding-top:10px; }
  .zoom-row{ display:grid; grid-template-columns: 1fr 60px; align-items:center; gap:10px; }
  .zoom-row input[type="range"]{ width:100% }

  .avatar-lg{ width:64px; height:64px; border-radius:50%; overflow:hidden; border:1px solid rgba(255,255,255,.14); background:#0f1428; }
  .avatar-lg img{ width:100%; height:100%; object-fit:cover; display:block; }

  @media (max-width: 410px){ .lang-pill{ display:none; } }
  @media (max-width: 400px){
    .modal-head { padding:8px 10px; gap:6px; }
    .modal-body { padding:8px 10px; }
    .modal-foot { padding:8px 10px; gap:6px; }
    .round-row { grid-template-columns: auto 80px 40px; gap:4px; font-size:12px; }
    .round-row strong { font-size:14px; }
    .round-row .hint { font-size:10px; }
    .round-row input[type="number"] { height:28px; padding:2px 6px; font-size:12px; }
    .round-row .minus10 { height:28px; font-size:12px; padding:0; }
  }
</style>
</head>
<body>
<div class="app" id="app">

  <!-- Non-scrolling top -->
  <header>
    <div class="brand">
      <div class="title" id="appTitle">Conga by Alanis</div>
      <div class="ver" id="verLine">STAGE v3.7.6</div>
    </div>

    <div class="lang-pill" id="langPill" aria-label="Language">
      <button data-lang="en" id="pillEn" class="active">EN</button><span>/</span>
      <button data-lang="es" id="pillEs">ES</button>
    </div>

    <button id="openSettings" class="iconbtn" aria-label="Settings">‚öôÔ∏è</button>
  </header>

  <section class="card">
    <div class="tools">
      <button id="lockToggle" class="btn" aria-label="Reorder">üîí <span data-i18n="reorder">Reorder</span></button>
      <button id="historyBtn" class="btn"><span data-i18n="history">History</span></button>
      <button id="newRoundBtn" class="btn primary"><span data-i18n="newRound">New round</span></button>
    </div>
    <div id="dealerLine"></div>
  </section>

  <!-- Scrollable center -->
  <section id="playersPane" class="players-pane">
    <div class="players">
      <header><div data-i18n="players">Players</div></header>
      <div id="playersList" role="list" aria-live="polite"></div>
      <button class="btn" id="addPlayerBtn" style="width:100%; margin-top:6px">+ <span data-i18n="addPlayer">Add player</span></button>
    </div>
  </section>
</div>

<!-- SETTINGS -->
<dialog id="settingsDialog" aria-labelledby="settingsTitle" role="dialog" aria-modal="true">
  <div class="modal-head">
    <div id="settingsTitle" style="font-weight:800" data-i18n="settings">Settings</div>
    <button class="btn" onclick="settingsDialog.close()" style="padding:6px 10px" data-i18n="close">Close</button>
  </div>
  <div class="modal-body">
    <div>
      <label for="limitInput" data-i18n="limitLabel">Limit (default 100)</label>
      <input id="limitInput" type="number" inputmode="numeric" min="1" step="1" />
    </div>

    <label class="switch">
      <input id="autoAdvance" type="checkbox" checked />
      <span class="track" aria-hidden="true"></span>
      <span class="thumb" aria-hidden="true"></span>
      <span class="switch-label" data-i18n="autoAdvance">Auto-advance dealer after round</span>
    </label>

    <label class="switch">
      <input id="lockOrderSwitch" type="checkbox" />
      <span class="track" aria-hidden="true"></span>
      <span class="thumb" aria-hidden="true"></span>
      <span class="switch-label" data-i18n="lockOrder">Lock player reordering</span>
    </label>

    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="resetScoresBtn" data-i18n="resetScores">Reset scores</button>
      <button class="btn" id="clearAllBtn" data-i18n="clearAll">Clear all</button>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn success" onclick="settingsDialog.close()" data-i18n="done">Done</button>
  </div>
</dialog>

<!-- Round dialog -->
<dialog id="roundDialog" aria-labelledby="roundTitle" role="dialog" aria-modal="true">
  <div class="modal-head">
    <div style="flex:1; overflow:hidden;">
      <div id="roundTitle" style="font-weight:800" data-i18n="newRound">New Round</div>
    </div>
    <button class="btn" style="flex-shrink:0; padding:6px 10px" onclick="roundDialog.close()" data-i18n="close">Close</button>
  </div>
  <form id="roundForm">
    <div class="modal-body">
      <div class="grid-rows" id="roundRows"></div>
    </div>
    <div class="modal-foot">
      <div id="roundError" class="error" style="display:none"></div>
      <button type="button" class="btn" onclick="roundDialog.close()" data-i18n="cancel">Cancel</button>
      <button id="applyRoundBtn" type="button" class="btn success" data-i18n="apply">Apply</button>
    </div>
  </form>
</dialog>

<!-- Edit player dialog -->
<dialog id="editDialog" aria-labelledby="editTitle" role="dialog" aria-modal="true">
  <div class="modal-head">
    <div id="editTitle" style="font-weight:800" data-i18n="editPlayer">Edit player</div>
    <button class="btn" onclick="editDialog.close()" style="padding:6px 10px" data-i18n="close">Close</button>
  </div>
  <form id="editForm">
    <div class="modal-body">
      <input type="hidden" id="editId" />
      <div style="display:grid; gap:10px">
        <div>
          <label for="editName" data-i18n="name">Name</label>
          <input id="editName" type="text" required />
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
          <div>
            <label for="editScore" data-i18n="score">Score</label>
            <input id="editScore" type="number" step="1" />
          </div>
          <div>
            <label for="editReeng" data-i18n="reenganches">Reenganches</label>
            <input id="editReeng" type="number" step="1" min="0" />
          </div>
        </div>

        <div style="display:grid; gap:10px; margin-top:6px">
          <div>
            <label data-i18n="photo">Photo</label>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
              <div class="avatar-lg"><img id="editAvatarPreview" alt=""></div>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button type="button" class="btn" id="changePhotoBtn" data-i18n="addPhoto">Add photo</button>
                <button type="button" class="btn" id="removePhotoBtn" data-i18n="removePhoto">Remove photo</button>
              </div>
            </div>
          </div>
          <label class="switch">
            <input id="setDealerSwitch" type="checkbox">
            <span class="track" aria-hidden="true"></span>
            <span class="thumb" aria-hidden="true"></span>
            <span class="switch-label" data-i18n="setDealer">Set as next dealer</span>
          </label>
          <div>
            <button type="button" class="btn" id="deletePlayerBtn" data-i18n="deletePlayer">Delete player</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" type="button" onclick="editDialog.close()" data-i18n="cancel">Cancel</button>
      <button class="btn success" type="submit" data-i18n="save">Save</button>
    </div>
  </form>
</dialog>

<!-- Crop dialog -->
<dialog id="cropDialog" aria-labelledby="cropTitle" role="dialog" aria-modal="true">
  <div class="modal-head">
    <div id="cropTitle" style="font-weight:800">Crop Photo</div>
    <button class="btn" onclick="cropDialog.close()" style="padding:6px 10px" data-i18n="close">Close</button>
  </div>
  <div class="modal-body">
    <div id="cropStage"><canvas id="cropCanvas"></canvas></div>
    <div class="crop-controls">
      <div class="zoom-row">
        <input id="zoomRange" type="range" min="0" max="100" value="0" step="1" aria-label="Zoom">
        <output id="zoomOut" style="text-align:right; font-variant-numeric:tabular-nums">100%</output>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn" id="pickAnotherBtn">Choose photo</button>
        <button class="btn success" id="applyCropBtn">Apply</button>
      </div>
    </div>
  </div>
</dialog>

<!-- Win overlay -->
<div class="win-overlay" id="winOverlay" aria-live="polite" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(5,8,20,.55); z-index:9999; padding:16px">
  <div class="win-card" style="width:min(520px,94vw); border-radius:20px; padding:14px; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)), #0f1428; box-shadow:0 24px 64px rgba(0,0,0,.55); position:relative; overflow:hidden">
    <canvas id="confettiCanvas"></canvas>
    <div class="win-head" style="display:flex; align-items:center; gap:12px">
      <div class="win-photo" style="width:56px; height:56px; border-radius:50%; overflow:hidden; border:2px solid #4ee1a0; box-shadow:0 0 0 4px rgba(78,225,160,.25)"><img id="winPhoto" alt=""></div>
      <div>
        <div class="win-name" id="winName" style="font-size:20px; font-weight:900">Winner</div>
        <div class="win-sub" id="winSubtitle" data-i18n="winner">WINNER</div>
      </div>
    </div>
    <div class="win-actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap">
      <button class="btn success" id="newGameBtn2" data-i18n="newGame">New game</button>
      <button class="btn" id="winCloseBtn" data-i18n="close">Close</button>
    </div>
  </div>
</div>

<audio id="winSound" preload="auto">
  <source type="audio/mp3"
    src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAAQAAABgAABcAAABWAAACAAACAQAAAC4AAABfAAAAdwAAAIQAAACkAAAAvwAAAN4AAAD///8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAAAgP8AAP//AP//AP8AAP//AAAAAP8AAP//AP//AP//AP//AP//AP//AAAAAAA="/>
</audio>

<input id="photoInput" type="file" accept="image/*" hidden>

<template id="playerRowTpl">
  <div class="row" title="Long-press to Edit (when locked)">
    <div class="drag" aria-hidden="true">‚â°</div>
    <div class="avatar" aria-hidden="true"><span class="initials">P</span></div>
    <strong class="playerName">Player</strong>
    <div class="scorewrap">
      <span class="stars" aria-label="Reenganches"></span>
      <span class="score" aria-label="Score"><span class="scoreVal">0</span></span>
    </div>
  </div>
</template>

<script>
(() => {
  "use strict";

  const APP = { NAME:"Conga by Alanis", CHANNEL:"STAGE", VERSION:"3.7.6", STORAGE_KEY:"conga_state_v2", SCHEMA:2 };
  document.title = `${APP.NAME} ‚Äî ${APP.CHANNEL} v${APP.VERSION}`;
  const verLineEl = document.getElementById("verLine"); if (verLineEl) verLineEl.textContent = `${APP.CHANNEL} v${APP.VERSION}`;

  /* utils */
  const $ = s => document.querySelector(s);
  const on = (sel, ev, fn, opt) => { const el = $(sel); if (el) el.addEventListener(ev, fn, opt||false); };
  const uid=()=> "p"+Math.random().toString(36).slice(2)+Date.now().toString(36);
  const clampInt=(v,d=0)=>Number.isFinite(+v)?Math.trunc(+v):d;
  const initials=(n)=> (n||" ").trim().split(/\s+/).map(s=>s[0]).join("").slice(0,2).toUpperCase();
  const toast = (m)=>{ const t=document.createElement('div'); t.className='toast'; t.textContent=m;
    t.style.cssText="position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111827;color:#e5e7eb;padding:10px 14px;border-radius:10px;border:1px solid #374151;z-index:99999;font-weight:800;letter-spacing:.2px";
    document.body.appendChild(t); setTimeout(()=>t.remove(),1400); };

  let saveTimer; const debounceSave = () => { clearTimeout(saveTimer); saveTimer = setTimeout(save, 300); };

  // IMPORTANT: do not flip body overflow anymore; dialogs already block page.
  const showModalWithLock = (dlg) => { if (dlg) { dlg.showModal(); dlg.scrollTop = 0; } };

  /* i18n */
  const STR = { en:{reorder:"Reorder",history:"History",newRound:"New round",players:"Players",addPlayer:"Add player",
      settings:"Settings",limitLabel:"Limit (default 100)",autoAdvance:"Auto-advance dealer after round",lockOrder:"Lock player reordering",
      resetScores:"Reset scores",clearAll:"Clear all",done:"Done",cancel:"Cancel",apply:"Apply",editPlayer:"Edit player",
      name:"Name",score:"Score",reenganches:"Reenganches",photo:"Photo",addPhoto:"Add photo",editPhoto:"Edit photo",removePhoto:"Remove photo",
      setDealer:"Set as next dealer",deletePlayer:"Delete player",save:"Save",winner:"WINNER",close:"Close",newGame:"New game"},
    es:{reorder:"Reordenar",history:"Historial",newRound:"Nueva ronda",players:"Jugadores",addPlayer:"Agregar jugador",
      settings:"Ajustes",limitLabel:"L√≠mite (por defecto 100)",autoAdvance:"Avanzar mano autom√°ticamente",lockOrder:"Bloquear reordenamiento",
      resetScores:"Reiniciar puntajes",clearAll:"Borrar todo",done:"Listo",cancel:"Cancelar",apply:"Aplicar",editPlayer:"Editar jugador",
      name:"Nombre",score:"Puntos",reenganches:"Reenganches",photo:"Foto",addPhoto:"Agregar foto",editPhoto:"Editar foto",removePhoto:"Quitar foto",
      setDealer:"Fijar como pr√≥ximo mano",deletePlayer:"Eliminar jugador",save:"Guardar",winner:"GANADOR",close:"Cerrar",newGame:"Nuevo juego"} };
  const storageLangKey="conga_lang"; let LANG=localStorage.getItem(storageLangKey)||"en";
  function t(k){ return (STR[LANG] && STR[LANG][k]) || STR.en[k] || k; }
  function applyI18n(){ document.querySelectorAll("[data-i18n]").forEach(n=>n.textContent=t(n.dataset.i18n)); $("#pillEn")?.classList.toggle("active",LANG==="en"); $("#pillEs")?.classList.toggle("active",LANG==="es"); }

  /* state */
  let players=[], limit=100, nextDealerId=null, autoAdvanceDealer=true, gameOver=false;
  let roundCounter=0; let rounds=[]; let lockOrder=false; let schema=APP.SCHEMA;

  const defaultsPlayers = ()=>[{id:uid(),name:"Player 1",score:0,reenganches:0,avatar:null},{id:uid(),name:"Player 2",score:0,reenganches:0,avatar:null}];

  const save=()=>localStorage.setItem(APP.STORAGE_KEY, JSON.stringify({schema,players,limit,nextDealerId,autoAdvanceDealer,gameOver,roundCounter,rounds,lockOrder,app:{version:APP.VERSION}}));

  function load(){
    try{
      const s=JSON.parse(localStorage.getItem(APP.STORAGE_KEY)||"null");
      if(s){ ({schema,players,limit,nextDealerId,autoAdvanceDealer,gameOver,roundCounter,rounds,lockOrder}=s); }
      if(!Array.isArray(players)||players.length===0){ players=defaultsPlayers(); }
      if(!nextDealerId){ nextDealerId=players[0]?.id||null; }
    }catch{ players=defaultsPlayers(); nextDealerId=players[0].id; }
  }

  /* render */
  const list=$("#playersList"), playersPane=$("#playersPane"), rowTpl=$("#playerRowTpl"), dealerLine=$("#dealerLine");
  function render(){
    // preserve players pane scroll position across re-renders
    const preserveScroll = playersPane ? playersPane.scrollTop : 0;

    $("#limitInput").value=limit; $("#autoAdvance").checked=autoAdvanceDealer; $("#lockOrderSwitch").checked=lockOrder;
    $("#lockToggle").innerHTML=(lockOrder?"üîí ":"üîì ")+t("reorder");
    if(dealerLine){ const d=players.find(p=>p.id===nextDealerId); dealerLine.textContent=d?`${LANG==='es'?'Pr√≥ximo mano:':'Next dealer:'} ${d.name}`:""; }
    if(list){
      const frag=document.createDocumentFragment();
      players.forEach((p,i)=>{
        const n=rowTpl.content.firstElementChild.cloneNode(true);
        n.dataset.index=i; n.dataset.id=p.id;

        /* edit only when locked */
        if(lockOrder) attachLongPress(n, ()=>openEdit(p.id));

        /* live reorder when unlocked */
        const handle=n.querySelector('.drag');
        if(!lockOrder){ handle.classList.remove('locked'); enableLiveReorder(handle, n); }
        else { handle.classList.add('locked'); handle.onpointerdown=handle.ontouchstart=handle.onmousedown=null; }

        if(p.id===nextDealerId) n.classList.add("dealer");
        const avatarBox=n.querySelector(".avatar");
        avatarBox.innerHTML = p.avatar ? `<img alt="" src="${p.avatar}">` : `<span class="initials">${initials(p.name||"")}</span>`;
        n.querySelector(".playerName").textContent=p.name||"‚Äî";
        const r=clampInt(p.reenganches||0,0); n.querySelector(".stars").textContent=r>0?(r===1?"‚òÖ":"‚òÖ "+r):"";
        const sv=n.querySelector(".scoreVal"); sv.textContent=clampInt(p.score||0);
        const sc=n.querySelector(".score"); if((p.score||0)>=limit+1) sc.classList.add("over"); else sc.classList.remove("over");
        frag.appendChild(n);
      });
      list.innerHTML=""; list.appendChild(frag);
    }
    applyI18n(); debounceSave();

    // restore scroll (keeps header/tools always visible)
    if(playersPane) playersPane.scrollTop = preserveScroll;
  }

  function attachLongPress(el, cb){
    let tmr, moved=false;
    const start=e=>{ e.preventDefault(); moved=false; tmr=setTimeout(()=>{ if(!moved) cb(); },600); };
    const end=()=>clearTimeout(tmr);
    el.addEventListener('touchstart',start,{passive:false}); el.addEventListener('mousedown',start);
    el.addEventListener('touchmove',()=>{moved=true;},{passive:true});
    ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>el.addEventListener(ev,end));
  }

  /* ===== Live reorder (ghost + placeholder) ===== */
  function enableLiveReorder(handle, rowEl){
    const start=(e)=>{
      if(lockOrder) return;
      const isTouch = e.touches && e.touches.length;
      const clientX = isTouch ? e.touches[0].clientX : (e.clientX ?? 0);
      const clientY = isTouch ? e.touches[0].clientY : (e.clientY ?? 0);

      const rect = rowEl.getBoundingClientRect();
      const startIdx = +rowEl.dataset.index;

      // placeholder
      const ph = document.createElement('div');
      ph.className = 'row placeholder';
      ph.style.height = rect.height + 'px';

      // ghost
      const ghost = rowEl.cloneNode(true);
      ghost.classList.add('drag-ghost');
      ghost.style.width = rect.width + 'px';
      ghost.style.transform = `translate3d(${rect.left}px, ${rect.top}px, 0)`;

      // offset
      const offsetX = clientX - rect.left;
      const offsetY = clientY - rect.top;

      // mount
      const parent = list;
      parent.insertBefore(ph, rowEl);
      rowEl.remove();
      document.body.appendChild(ghost);

      // keep scroll inside players pane
      const pr = playersPane.getBoundingClientRect();
      const edge = 36;

      const move = (cx, cy) => {
        ghost.style.transform = `translate3d(${cx - offsetX}px, ${cy - offsetY}px, 0)`;

        // auto-scroll players pane near edges
        if (cy < pr.top + edge) playersPane.scrollBy({top:-14, behavior:'auto'});
        else if (cy > pr.bottom - edge) playersPane.scrollBy({top:14, behavior:'auto'});

        // re-position placeholder by ghost center
        const centerY = cy;
        const rows = Array.from(parent.querySelectorAll('.row')); // includes placeholder
        const target = rows.find(el => el !== ph && (centerY < el.getBoundingClientRect().top + el.offsetHeight/2));
        if (target) parent.insertBefore(ph, target); else parent.appendChild(ph);
      };

      const detach = () => {
        window.removeEventListener('pointermove', onPointerMove);
        window.removeEventListener('pointerup', onPointerUp);
        window.removeEventListener('touchmove', onTouchMove);
        window.removeEventListener('touchend', onTouchEnd);
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
      };

      const end = () => {
        const kids = Array.from(parent.children);
        const toIdx = kids.indexOf(ph);
        ghost.remove(); ph.remove();
        if (Number.isInteger(startIdx) && Number.isInteger(toIdx) && startIdx !== toIdx) {
          const arr = players.slice(); const keepDealer = nextDealerId;
          const moving = arr.splice(startIdx,1)[0]; arr.splice(toIdx,0,moving);
          players = arr; nextDealerId = keepDealer;
        }
        render();
        detach();
      };

      const onPointerMove = ev => { ev.preventDefault(); move(ev.clientX, ev.clientY); };
      const onTouchMove = ev => { const t=ev.touches[0]; if(!t) return; ev.preventDefault(); move(t.clientX, t.clientY); };
      const onMouseMove = ev => { ev.preventDefault(); move(ev.clientX, ev.clientY); };

      const onPointerUp = ev => { ev.preventDefault(); end(); };
      const onTouchEnd = ev => { ev.preventDefault(); end(); };
      const onMouseUp = ev => { ev.preventDefault(); end(); };

      window.addEventListener('pointermove', onPointerMove, {passive:false});
      window.addEventListener('pointerup', onPointerUp, {passive:false});
      window.addEventListener('touchmove', onTouchMove, {passive:false});
      window.addEventListener('touchend', onTouchEnd, {passive:false});
      window.addEventListener('mousemove', onMouseMove, {passive:false});
      window.addEventListener('mouseup', onMouseUp, {passive:false});

      e.preventDefault();
      move(clientX, clientY);
    };

    handle.onpointerdown = start;
    handle.ontouchstart = start;
    handle.onmousedown = start;
  }

  /* ===== Edit dialog ===== */
  const editDlg=$("#editDialog"), editForm=$("#editForm");
  function refreshEditPreview(id){ const p=players.find(x=>x.id===id); const prev=$("#editAvatarPreview"), btn=$("#changePhotoBtn");
    if(prev){ prev.src=p?.avatar||""; prev.style.opacity=p?.avatar?"1":".35"; }
    if(btn){ const key=p?.avatar?"editPhoto":"addPhoto"; btn.setAttribute("data-i18n",key); btn.textContent=t(key); }
  }
  function openEdit(id){
    const p=players.find(x=>x.id===id); if(!p) return;
    $("#editId").value=p.id; $("#editName").value=p.name||""; $("#editScore").value=clampInt(p.score||0); $("#editReeng").value=clampInt(p.reenganches||0);
    $("#setDealerSwitch").checked=(p.id===nextDealerId);
    refreshEditPreview(p.id);
    $("#changePhotoBtn").onclick=()=>openCrop(p.id, p.avatar);
    $("#removePhotoBtn").onclick=()=>{ p.avatar=null; refreshEditPreview(p.id); render(); };
    $("#deletePlayerBtn").onclick=()=>{ if(confirm(LANG==="es"?"¬øEliminar jugador?":"Delete this player?")){ editDlg.close(); removePlayer(p.id); } };
    showModalWithLock(editDlg);
  }
  editForm?.addEventListener("submit",(e)=>{
    e.preventDefault();
    const id=$("#editId").value; const p=players.find(x=>x.id===id); if(!p){ editDlg.close(); return; }
    p.name=String($("#editName").value||"").trim()||p.name;
    p.score=clampInt($("#editScore").value,p.score);
    p.reenganches=Math.max(0,clampInt($("#editReeng").value,p.reenganches));
    if($("#setDealerSwitch").checked) nextDealerId=p.id;
    editDlg.close(); render();
  });

  /* ===== Circular cropper ===== */
  const cropDlg=$("#cropDialog"), cropStage=$("#cropStage"), cropCanvas=$("#cropCanvas"), zoomRange=$("#zoomRange"), zoomOut=$("#zoomOut"),
        pickAnotherBtn=$("#pickAnotherBtn"), applyCropBtn=$("#applyCropBtn"), photoInput=$("#photoInput");
  const ctx=cropCanvas.getContext('2d');
  let cropPlayerId=null, img=new Image(), imgLoaded=false, scale=1, minScale=1, maxScale=4, offsetX=0, offsetY=0;
  let pinchDist0=null, scale0=null; const touches=new Map(); let panning=false, startPanX=0, startPanY=0;

  function dprSize(el){ const DPR=window.devicePixelRatio||1; return [el.clientWidth*DPR, el.clientHeight*DPR, DPR]; }
  function circleSpecs(){ const w=cropCanvas.width, h=cropCanvas.height, DPR=window.devicePixelRatio||1, pad=12*DPR; const r=Math.min(w,h)/2 - pad; return {cx:w/2, cy:h/2, r, DPR}; }
  function coverMinScale(){ const {r}=circleSpecs(); return Math.max((2*r)/img.width, (2*r)/img.height)*1.001; }
  function clampPan(){ const {cx,cy,r}=circleSpecs(); const w=img.width*scale, h=img.height*scale;
    if (offsetX > cx - r) offsetX = cx - r;
    if (offsetY > cy - r) offsetY = cy - r;
    if (offsetX + w < cx + r) offsetX = (cx + r) - w;
    if (offsetY + h < cy + r) offsetY = (cy + r) - h;
  }
  function drawCrop(){
    const [cw,ch]=dprSize(cropStage); if(cropCanvas.width!==cw||cropCanvas.height!==ch){ cropCanvas.width=cw; cropCanvas.height=ch; }
    ctx.clearRect(0,0,cw,ch);
    const {cx,cy,r}=circleSpecs();
    if(imgLoaded){ const w=img.width*scale, h=img.height*scale; ctx.drawImage(img, offsetX, offsetY, w, h); }
    ctx.save(); ctx.fillStyle='rgba(0,0,0,.55)'; ctx.beginPath(); ctx.rect(0,0,cw,ch); ctx.moveTo(cx+r, cy); ctx.arc(cx,cy,r,0,Math.PI*2,true); ctx.fill('evenodd'); ctx.restore();
    ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent-2')||'#4ee1a0'; ctx.lineWidth=Math.max(2,r*0.04); ctx.stroke(); ctx.restore();
  }
  function setZoomBySlider(val){ const t=val/100; scale=minScale+(maxScale-minScale)*t; zoomOut.textContent=Math.round(scale/minScale*100)+'%'; clampPan(); drawCrop(); }

  function openCrop(playerId, existingAvatar=null){
    cropPlayerId=playerId;
    const ensureShow=cb=>{ showModalWithLock(cropDlg); requestAnimationFrame(()=>{ drawCrop(); requestAnimationFrame(cb); }); };
    const useImage=src=>{ imgLoaded=false; img=new Image(); img.onload=()=>{
        imgLoaded=true; minScale=coverMinScale(); maxScale=Math.max(minScale*4, minScale+0.01); scale=minScale*1.05;
        const {cx,cy}=circleSpecs(); const w=img.width*scale, h=img.height*scale; offsetX=cx-w/2; offsetY=cy-h/2; clampPan();
        const t=(scale-minScale)/(maxScale-minScale); zoomRange.value=Math.round(t*100); zoomOut.textContent=Math.round(scale/minScale*100)+'%';
        drawCrop(); cropDialog.scrollTop=0;
      }; img.src=src; };
    if (existingAvatar){ ensureShow(()=>useImage(existingAvatar)); }
    else { photoInput.onchange=async()=>{ const f=photoInput.files[0]; if(!f) return;
        const dataUrl=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
        ensureShow(()=>useImage(dataUrl)); }; photoInput.click(); }
  }
  cropStage.addEventListener('pointerdown',e=>{ cropStage.setPointerCapture(e.pointerId); touches.set(e.pointerId,{x:e.clientX,y:e.clientY});
    if(touches.size===2){ const pts=[...touches.values()]; pinchDist0=Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y); scale0=scale; }
    else if(touches.size===1){ panning=true; startPanX=e.clientX-offsetX; startPanY=e.clientY-offsetY; } });
  cropStage.addEventListener('pointermove',e=>{ if(!imgLoaded||!touches.has(e.pointerId)) return; touches.set(e.pointerId,{x:e.clientX,y:e.clientY});
    if(touches.size===2){ const pts=[...touches.values()]; const dist=Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
      if(pinchDist0&&scale0){ const ratio=dist/pinchDist0; scale=Math.min(maxScale,Math.max(minScale,scale0*ratio)); const t=(scale-minScale)/(maxScale-minScale); zoomRange.value=Math.round(t*100); zoomOut.textContent=Math.round(scale/minScale*100)+'%'; clampPan(); drawCrop(); } }
    else if(panning){ offsetX=e.clientX-startPanX; offsetY=e.clientY-startPanY; clampPan(); drawCrop(); } }, {passive:false});
  function endPtr(e){ touches.delete(e.pointerId); if(touches.size<2){ pinchDist0=null; scale0=null; } if(touches.size===0){ panning=false; } }
  cropStage.addEventListener('pointerup',endPtr); cropStage.addEventListener('pointercancel',endPtr); cropStage.addEventListener('pointerleave',endPtr);
  zoomRange.addEventListener('input',e=>setZoomBySlider(+e.target.value));
  $("#pickAnotherBtn").addEventListener('click',()=>{ photoInput.onchange=async()=>{ const f=photoInput.files[0]; if(!f) return;
      const dataUrl=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
      openCrop(cropPlayerId, dataUrl); }; photoInput.click(); });
  $("#applyCropBtn").addEventListener('click',()=>{ if(!imgLoaded){ cropDlg.close(); return; }
    const {cx,cy,r}=circleSpecs(); const ox=(cx-offsetX)/scale, oy=(cy-offsetY)/scale, or=r/scale;
    const size=512; const out=document.createElement('canvas'); out.width=size; out.height=size; const octx=out.getContext('2d');
    octx.clearRect(0,0,size,size); octx.save(); octx.beginPath(); octx.arc(size/2,size/2,size/2,0,Math.PI*2); octx.clip();
    const S=(size/2)/or; octx.setTransform(S,0,0,S, size/2-ox*S, size/2-oy*S); octx.imageSmoothingQuality='high'; octx.drawImage(img,0,0); octx.restore();
    const dataOut=out.toDataURL('image/png',0.95); const p=players.find(x=>x.id===cropPlayerId); if(p){ p.avatar=dataOut; refreshEditPreview(p.id); render(); } cropDlg.close(); });

  /* ===== Round ===== */
  const roundDlg=$("#roundDialog"), rows=$("#roundRows"), applyRoundBtn=$("#applyRoundBtn");
  function openRound(){
    if(players.length===0){ toast(LANG==="es"?"Agrega jugadores primero":"Add players first"); return; }
    rows.innerHTML="";
    const frag=document.createDocumentFragment();
    players.forEach(p=>{ const r=document.createElement("div"); r.className="round-row";
      const name=document.createElement("div"); name.innerHTML=`<strong>${p.name}</strong><div class="hint">${t("score")}: ${p.score||0}</div>`;
      const inp=document.createElement("input"); inp.id="rr_"+p.id; inp.type="number"; inp.step="1"; inp.inputMode="numeric"; inp.placeholder="0"; inp.dataset.pid=p.id;
      const minus=document.createElement("button"); minus.type="button"; minus.className="minus10"; minus.textContent="-10"; minus.onclick=()=>{ inp.value=clampInt((inp.value===""?0:+inp.value)-10); };
      r.append(name,inp,minus); frag.appendChild(r);
    });
    rows.appendChild(frag);
    showModalWithLock(roundDlg);
    requestAnimationFrame(()=>{ roundDlg.scrollTop=0; rows.querySelector('input')?.focus({preventScroll:true}); });
  }
  function roundInputs(){ const m={}; for(const p of players){ const el=$("#rr_"+p.id); m[p.id]=clampInt(el && el.value!=="" ? el.value : 0,0);} return m; }
  applyRoundBtn.addEventListener('click', ()=>{ applyRound(roundInputs()); roundDlg.close(); });

  function snapshotTotalsById(){ const o={}; for(const p of players) o[p.id]=clampInt(p.score||0); return o; }

  function applyRound(inputs){
    const roundNo=roundCounter+1;
    const proj={}; players.forEach(p=>proj[p.id]=clampInt(p.score||0)+clampInt(inputs[p.id]||0));

    roundCounter+=1;
    const REENG_THRESHOLD=limit+1; // at exactly 101+ when limit=100
    const under=players.filter(p=>proj[p.id]<=limit);
    const over=players.filter(p=>proj[p.id]>=REENG_THRESHOLD);

    if(under.length>=2 && over.length>0){
      const maxUnderVal=Math.max(...under.map(p=>proj[p.id]));
      over.forEach(p=>{ proj[p.id]=maxUnderVal; p.reenganches=(p.reenganches||0)+1; });
    }else if(under.length===0){
      players.forEach(p=>{ proj[p.id]=Math.min(proj[p.id],limit); });
      toast(LANG==="es"?"Todos excedieron - limitado":"All over limit - capped");
    }

    players.forEach(p=>{ p.score=proj[p.id]; });

    if(autoAdvanceDealer && players.length>0 && nextDealerId){
      const i=players.findIndex(p=>p.id===nextDealerId);
      nextDealerId=players[(i>=0&&i<players.length-1)?i+1:0].id;
    }

    rounds.push({round:roundNo, inputs:{...inputs}, totals:snapshotTotalsById(), timestamp:Date.now()});
    gameOver=false;

    const alive=players.filter(p=>p.score<=limit);
    if(alive.length===1){ gameOver=true; showWinOverlay(alive[0]); }
    render();
  }

  /* History */
  function openRoundsTable(){
    const dlg=document.createElement('dialog');
    dlg.innerHTML = `<div class="modal-head"><div style="font-weight:800">History</div><button class="btn" style="padding:6px 10px">Close</button></div><div class="modal-body"><div class="table-wrap"></div></div>`;
    const twrap=dlg.querySelector('.table-wrap');
    const table=document.createElement('table'); const thead=document.createElement('thead'); const trh=document.createElement('tr');
    trh.innerHTML="<th>#</th>"+players.map(p=>`<th>${p.name} (Œî / Total)</th>`).join(""); thead.appendChild(trh); table.appendChild(thead);
    const tbody=document.createElement('tbody');
    rounds.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<th>${r.round}</th>`+players.map(p=>`<td>${(r.inputs&&r.inputs[p.id]!=null)?r.inputs[p.id]:"0"} / ${(r.totals&&r.totals[p.id]!=null)?r.totals[p.id]:"0"}</td>`).join(""); tbody.appendChild(tr); });
    table.appendChild(tbody); twrap.appendChild(table);
    dlg.querySelector("button").onclick=()=>dlg.close(); document.body.appendChild(dlg); showModalWithLock(dlg);
  }

  /* Wire-up */
  on("#openSettings","click",()=>showModalWithLock($("#settingsDialog")));
  on("#historyBtn","click",openRoundsTable);
  on("#newRoundBtn","click",openRound);
  on("#addPlayerBtn","click",()=>{ const name=prompt(LANG==="es"?"¬øNombre del jugador?":"Player name?"); if(name!==null){ addPlayer(String(name).trim()||undefined); } });
  on("#resetScoresBtn","click",()=>{ if(players.length&&confirm(LANG==="es"?"¬øReiniciar puntajes y reenganches?":"Reset all scores and reenganches?")){ players.forEach(p=>{p.score=0;p.reenganches=0;}); gameOver=false; render(); } });
  on("#clearAllBtn","click",()=>{ if(confirm(LANG==="es"?"¬øBorrar todo?":"Clear all players and settings?")){ players=defaultsPlayers(); limit=100; nextDealerId=players[0].id; autoAdvanceDealer=true; gameOver=false; rounds=[]; roundCounter=0; lockOrder=false; render(); }});
  on("#lockToggle","click",()=>{ lockOrder=!lockOrder; $("#lockOrderSwitch").checked=lockOrder; render(); });
  on("#lockOrderSwitch","change",e=>{ lockOrder=!!e.target.checked; render(); });
  on("#limitInput","input",e=>{ const v=clampInt(e.target.value,limit); limit=Math.max(1,v); render(); });
  on("#autoAdvance","change",e=>{ autoAdvanceDealer=!!e.target.checked; render(); });
  $("#pillEn")?.addEventListener("click",()=>{ LANG="en"; localStorage.setItem(storageLangKey,LANG); applyI18n(); render(); });
  $("#pillEs")?.addEventListener("click",()=>{ LANG="es"; localStorage.setItem(storageLangKey,LANG); applyI18n(); render(); });

  const addPlayer=(name="")=>{ const p={id:uid(),name:name||("Player "+(players.length+1)),score:0,reenganches:0,avatar:null}; players.push(p); if(!nextDealerId && players[0]) nextDealerId=players[0].id; gameOver=false; render(); };
  const removePlayer=id=>{ const i=players.findIndex(p=>p.id===id); if(i<0) return; const was=players[i].id===nextDealerId; players.splice(i,1); if(!players.length) nextDealerId=null; else if(was) nextDealerId=players[Math.min(i,players.length-1)].id; render(); };

  /* Win overlay */
  let confettiRaf;
  function showWinOverlay(winner){
    const ov=$("#winOverlay"); if(!ov) return;
    $("#winName").textContent=winner?.name||'Winner';
    $("#winPhoto").src=winner?.avatar||'';
    ov.style.display='flex';
    try{ $("#winSound").play().catch(()=>{});}catch{}
    startConfetti();
  }
  $("#winCloseBtn")?.addEventListener('click',()=>{ $("#winOverlay").style.display='none'; stopConfetti(); });
  $("#newGameBtn2")?.addEventListener('click',()=>{ players.forEach(p=>{p.score=0;p.reenganches=0;}); gameOver=false; rounds=[]; roundCounter=0; $("#winOverlay").style.display='none'; stopConfetti(); render(); window.scrollTo({top:0,behavior:"smooth"}); });
  function stopConfetti(){ if(confettiRaf) cancelAnimationFrame(confettiRaf); }
  function startConfetti(){ const c=$("#confettiCanvas"); if(!c) return; const ctx=c.getContext('2d'); const DPR=window.devicePixelRatio||1;
    const W=c.parentElement.clientWidth, H=c.parentElement.clientHeight; c.width=W*DPR; c.height=H*DPR; ctx.scale(DPR,DPR);
    const N=80; const pieces=Array.from({length:N},()=>({x:Math.random()*W,y:-10-Math.random()*H,r:2+Math.random()*4,vy:2+Math.random()*3,vx:-1+Math.random()*2,a:Math.random()*Math.PI*2,color:`hsl(${Math.floor(Math.random()*360)},90%,60%)`}));
    const tick=()=>{ ctx.clearRect(0,0,W,H); pieces.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.a+=0.1; if(p.y>H+20){ p.y=-20; p.x=Math.random()*W; } ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=p.color; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore(); }); confettiRaf=requestAnimationFrame(tick); };
    stopConfetti(); tick(); setTimeout(stopConfetti,5000);
  }

  // init
  load(); applyI18n(); render();
})();
</script>
</body>
</html>
