<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=5" />
    <title>Conga Score Tracker STAGE</title>
    <meta name="theme-color" content="#0f1220" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and ReactDOM libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script type="text/babel">
        // Version: 1.0.0 (STAGE)
        // Created by Gemini

        // === HELPER FUNCTIONS ===
        const uid = () => `p${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`;
        const clampInt = (v, d = 0) => Number.isFinite(+v) ? Math.trunc(+v) : d;
        const getInitials = (name) => (name || " ").trim().split(/\s+/).map(s => s[0]).join("").slice(0, 2).toUpperCase();
        const createCSV = (players, nextDealerId) => {
          const header = ["name", "score", "reenganches", "isDealer"];
          const rows = players.map(p => [
            `"${String(p.name || "").replace(/"/g, '""')}"`,
            String(clampInt(p.score || 0)),
            String(clampInt(p.reenganches || 0)),
            String(p.id === nextDealerId)
          ]);
          const allRows = [header].concat(rows).map(r => r.join(",")).join("\n");
          const blob = new Blob(["\ufeff", allRows], { type: "text/csv;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "conga_scores.csv";
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
        };
        
        const App = () => {
          const [players, setPlayers] = React.useState(() => {
            const savedState = localStorage.getItem('conga_state_react');
            if (savedState) {
              const state = JSON.parse(savedState);
              return state.players || [];
            }
            return [{ id: uid(), name: "Player 1", score: 0, reenganches: 0, avatar: null }, { id: uid(), name: "Player 2", score: 0, reenganches: 0, avatar: null }];
          });
        
          const [gameState, setGameState] = React.useState(() => {
            const savedState = localStorage.getItem('conga_state_react');
            if (savedState) {
              const state = JSON.parse(savedState);
              return {
                limit: Number.isFinite(state.limit) ? state.limit : 100,
                nextDealerId: state.nextDealerId || (state.players && state.players[0] ? state.players[0].id : null),
                autoAdvanceDealer: typeof state.autoAdvanceDealer === 'boolean' ? state.autoAdvanceDealer : true,
                gameOver: !!state.gameOver,
                cutsHistory: Array.isArray(state.cutsHistory) ? state.cutsHistory : [],
                rounds: Array.isArray(state.rounds) ? state.rounds : [],
                roundCounter: Number.isFinite(state.roundCounter) ? state.roundCounter : 0,
                lockOrder: !!state.lockOrder,
                winsLog: Array.isArray(state.winsLog) ? state.winsLog : [],
              };
            }
            return {
              limit: 100,
              nextDealerId: null,
              autoAdvanceDealer: true,
              gameOver: false,
              cutsHistory: [],
              rounds: [],
              roundCounter: 0,
              lockOrder: false,
              winsLog: [],
            };
          });
        
          const [showRoundModal, setShowRoundModal] = React.useState(false);
          const [showEditModal, setShowEditModal] = React.useState(false);
          const [showSettingsModal, setShowSettingsModal] = React.useState(false);
          const [showHistoryModal, setShowHistoryModal] = React.useState(false);
          const [showCutsHistoryModal, setShowCutsHistoryModal] = React.useState(false);
          const [showWinOverlay, setShowWinOverlay] = React.useState(false);
        
          const [editPlayerId, setEditPlayerId] = React.useState(null);
          const [editPlayerName, setEditPlayerName] = React.useState('');
          const [editPlayerScore, setEditPlayerScore] = React.useState(0);
          const [editPlayerReeng, setEditPlayerReeng] = React.useState(0);
          const [editPlayerIsDealer, setEditPlayerIsDealer] = React.useState(false);
          const [editPlayerPhoto, setEditPlayerPhoto] = React.useState(null);
        
          const [roundScores, setRoundScores] = React.useState({});
          const [roundCutterId, setRoundCutterId] = React.useState(null);
          const [roundError, setRoundError] = React.useState('');
        
          const dragItem = React.useRef(null);
          const dragOverItem = React.useRef(null);
        
          React.useEffect(() => {
            const stateToSave = { players, ...gameState };
            localStorage.setItem('conga_state_react', JSON.stringify(stateToSave));
          }, [players, gameState]);
        
          React.useEffect(() => {
            if (!gameState.nextDealerId && players.length > 0) {
              setGameState(prev => ({ ...prev, nextDealerId: players[0].id }));
            }
          }, [players, gameState.nextDealerId]);
        
          const addPlayer = (name = "") => {
            const newPlayer = { id: uid(), name: name || `Player ${players.length + 1}`, score: 0, reenganches: 0, avatar: null };
            setPlayers(prev => [...prev, newPlayer]);
            setGameState(prev => ({ ...prev, gameOver: false }));
          };
        
          const removePlayer = (id) => {
            setPlayers(prev => {
              const newPlayers = prev.filter(p => p.id !== id);
              if (id === gameState.nextDealerId) {
                setGameState(prev => ({ ...prev, nextDealerId: newPlayers[0]?.id || null }));
              }
              return newPlayers;
            });
          };
        
          const handleDragStart = (e, index) => {
            dragItem.current = index;
          };
        
          const handleDragEnter = (e, index) => {
            dragOverItem.current = index;
          };
        
          const handleDragEnd = () => {
            if (dragItem.current === null || dragOverItem.current === null) return;
            const dragIndex = dragItem.current;
            const dropIndex = dragOverItem.current;
        
            const newPlayers = [...players];
            const draggedPlayer = newPlayers[dragIndex];
            newPlayers.splice(dragIndex, 1);
            newPlayers.splice(dropIndex, 0, draggedPlayer);
        
            setPlayers(newPlayers);
            dragItem.current = null;
            dragOverItem.current = null;
          };
        
          const openRoundModal = () => {
            if (players.length === 0 || gameState.gameOver) return;
            setRoundScores({});
            setRoundCutterId(null);
            setRoundError('');
            setShowRoundModal(true);
          };
        
          const validateRound = (scores, cutterId) => {
            const cutter = players.find(p => p.id === cutterId);
            if (!cutter) {
              setRoundError('Invalid cutter selected.');
              return false;
            }
            const projectedScore = clampInt(cutter.score) + clampInt(scores[cutterId] || 0);
            if (projectedScore > gameState.limit) {
              setRoundError(`Cutter's projected score cannot exceed ${gameState.limit}. (Projected: ${projectedScore})`);
              return false;
            }
            setRoundError('');
            return true;
          };
        
          const saveRound = (e) => {
            e.preventDefault();
            if (roundCutterId && !validateRound(roundScores, roundCutterId)) return;
        
            const roundNo = gameState.roundCounter + 1;
            const newPlayers = players.map(p => {
              const score = clampInt(p.score) + clampInt(roundScores[p.id] || 0);
              return { ...p, score };
            });
        
            let newGameOver = false;
            let newWinsLog = [...gameState.winsLog];
            let newCutsHistory = [...gameState.cutsHistory];
            const winningPlayer = newPlayers.find(p => p.score >= gameState.limit);
        
            if (winningPlayer) {
              const playersUnderLimit = newPlayers.filter(p => p.score <= gameState.limit);
              if (playersUnderLimit.length === 1) {
                newGameOver = true;
                const winner = playersUnderLimit[0];
                newWinsLog.push({ playerId: winner.id, name: winner.name, date: new Date().toISOString().slice(0, 10), timestamp: Date.now() });
                if (roundCutterId) {
                  const cutterEntry = { id: roundCutterId, name: players.find(p => p.id === roundCutterId)?.name || '—', round: roundNo, timestamp: Date.now(), result: roundCutterId === winner.id ? "cut_win" : "normal" };
                  newCutsHistory.push(cutterEntry);
                }
                setPlayers(newPlayers);
                setGameState(prev => ({
                  ...prev,
                  gameOver: newGameOver,
                  winsLog: newWinsLog,
                  cutsHistory: newCutsHistory,
                  roundCounter: roundNo,
                  rounds: [...prev.rounds, { round: roundNo, inputs: roundScores, totals: newPlayers.reduce((acc, p) => ({ ...acc, [p.id]: p.score }), {}), cutterId: roundCutterId, timestamp: Date.now() }],
                }));
                setShowRoundModal(false);
                setShowWinOverlay(true);
                return;
              }
            }
        
            const playersOverLimit = newPlayers.filter(p => p.score > gameState.limit);
            if (playersOverLimit.length > 0) {
              const playersUnderLimit = newPlayers.filter(p => p.score <= gameState.limit);
              if (playersUnderLimit.length > 0) {
                const maxUnderVal = Math.max(...playersUnderLimit.map(p => p.score));
                newPlayers.forEach(p => {
                  if (p.score > gameState.limit) {
                    p.score = maxUnderVal;
                    p.reenganches = clampInt(p.reenganches) + 1;
                  }
                });
              }
            }
            
            setPlayers(newPlayers);
        
            if (roundCutterId) {
              newCutsHistory.push({ id: roundCutterId, name: players.find(p => p.id === roundCutterId)?.name || '—', round: roundNo, timestamp: Date.now(), result: "normal" });
            }
        
            let newDealerId = gameState.nextDealerId;
            if (gameState.autoAdvanceDealer && players.length > 1) {
              const currentIndex = players.findIndex(p => p.id === gameState.nextDealerId);
              newDealerId = players[(currentIndex + 1) % players.length].id;
            }
        
            setGameState(prev => ({
              ...prev,
              nextDealerId: newDealerId,
              cutsHistory: newCutsHistory,
              roundCounter: roundNo,
              rounds: [...prev.rounds, { round: roundNo, inputs: roundScores, totals: newPlayers.reduce((acc, p) => ({ ...acc, [p.id]: p.score }), {}), cutterId: roundCutterId, timestamp: Date.now() }],
            }));
            setShowRoundModal(false);
          };
        
          const handleEditPlayer = (id) => {
            const player = players.find(p => p.id === id);
            if (!player) return;
            setEditPlayerId(id);
            setEditPlayerName(player.name);
            setEditPlayerScore(player.score);
            setEditPlayerReeng(player.reenganches);
            setEditPlayerIsDealer(player.id === gameState.nextDealerId);
            setEditPlayerPhoto(player.avatar);
            setShowEditModal(true);
          };
        
          const saveEditPlayer = (e) => {
            e.preventDefault();
            setPlayers(prev => prev.map(p => {
              if (p.id === editPlayerId) {
                return {
                  ...p,
                  name: editPlayerName,
                  score: clampInt(editPlayerScore),
                  reenganches: Math.max(0, clampInt(editPlayerReeng)),
                  avatar: editPlayerPhoto,
                };
              }
              return p;
            }));
            setGameState(prev => ({ ...prev, nextDealerId: editPlayerIsDealer ? editPlayerId : (prev.nextDealerId === editPlayerId ? null : prev.nextDealerId) }));
            setShowEditModal(false);
          };
        
          const resetGame = () => {
            setPlayers(prev => prev.map(p => ({ ...p, score: 0, reenganches: 0 })));
            setGameState(prev => ({ ...prev, gameOver: false, rounds: [], roundCounter: 0 }));
          };
        
          const clearAllData = () => {
            setPlayers([]);
            setGameState({
              limit: 100,
              nextDealerId: null,
              autoAdvanceDealer: true,
              gameOver: false,
              cutsHistory: [],
              rounds: [],
              roundCounter: 0,
              lockOrder: false,
              winsLog: [],
            });
          };
          
          const getWinner = () => {
              return players.find(p => p.score >= gameState.limit);
          }
        
          return (
            <div className="min-h-screen bg-[#0f1220] text-gray-100 p-4 font-sans flex flex-col items-center">
              <div className="w-full max-w-2xl bg-[#171a2b] shadow-xl rounded-2xl p-6 md:p-8 flex flex-col space-y-6">
                <header className="flex items-center justify-between gap-2 mb-2">
                  <div className="flex items-center gap-2">
                    <span className="bg-gradient-to-br from-[#7aa2ff] to-[#a77dff] text-[#0b0f1f] py-1 px-3 rounded-full font-extrabold text-xs uppercase tracking-wider">Conga / Chinchón</span>
                    <span className="text-xl md:text-2xl font-black tracking-wide">Alanis Scorekeeper</span>
                  </div>
                  <button onClick={() => setShowSettingsModal(true)} className="w-11 h-11 grid place-items-center rounded-xl border border-white/10 bg-[#0f1428] text-gray-100 hover:brightness-110 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.35a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.5a2 2 0 0 1-1 1.73l-.15.08a2 2 0 0 0-.73 2.73l.78 1.35a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2-2h.44a2 2 0 0 0 2 2v.18a2 2 0 0 1 1 1.73l.43.25a2 2 0 0 1 2 0l.15-.08a2 2 0 0 0 2.73-.73l.78-1.35a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.73v-.5a2 2 0 0 1 1-1.73l.15-.08a2 2 0 0 0 .73-2.73l-.78-1.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2-2V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                  </button>
                </header>
        
                <section className="bg-gray-800/50 border border-white/10 rounded-2xl p-4 mb-2 flex flex-col md:flex-row items-center gap-4">
                  <div className="flex-1 text-sm text-gray-300">
                    <strong>Next dealer:</strong> <span className="font-semibold text-white">{players.find(p => p.id === gameState.nextDealerId)?.name || '—'}</span>
                    <div className="text-xs text-gray-400 mt-1">Long-press player row to Edit.</div>
                  </div>
                  <div className="flex gap-2 w-full md:w-auto">
                    <button onClick={() => setGameState(prev => ({ ...prev, lockOrder: !prev.lockOrder }))} className="w-11 h-11 grid place-items-center rounded-xl border border-white/10 bg-gray-800/50 text-gray-100 hover:brightness-110 transition-all" title={gameState.lockOrder ? "Unlock player order" : "Lock player order"}>
                      {gameState.lockOrder ? '🔒' : '🔓'}
                    </button>
                    <button onClick={() => setShowHistoryModal(true)} className="flex-1 p-3 bg-gray-700/50 hover:bg-gray-700/80 rounded-lg text-white font-bold transition-all">History</button>
                    <button onClick={openRoundModal} className="flex-1 p-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-bold transition-all" disabled={players.length === 0 || gameState.gameOver}>New round</button>
                  </div>
                </section>
        
                <section className="space-y-2">
                  <h2 className="text-sm text-gray-400 ml-1">Players</h2>
                  <div className="space-y-3" onDragOver={(e) => e.preventDefault()}>
                    {players.map((player, index) => (
                      <div
                        key={player.id}
                        draggable={!gameState.lockOrder}
                        onDragStart={(e) => handleDragStart(e, index)}
                        onDragOver={(e) => e.preventDefault()}
                        onDragEnter={(e) => handleDragEnter(e, index)}
                        onDragEnd={handleDragEnd}
                        onClick={() => handleEditPlayer(player.id)}
                        className={`relative group flex items-center gap-3 p-3 rounded-xl border-2 transition-all cursor-pointer hover:bg-white/5
                          ${player.id === gameState.nextDealerId ? 'border-green-400 bg-green-900/20' : 'border-transparent bg-white/5'}
                          ${gameState.lockOrder ? 'cursor-not-allowed' : ''}
                        `}
                      >
                        <div className={`text-xl text-gray-400 transition-opacity ${gameState.lockOrder ? 'opacity-50' : ''}`}>
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 21.25a.75.75 0 0 1-.75-.75V3.5a.75.75 0 0 1 1.5 0v17a.75.75 0 0 1-.75.75z"/><path d="M16 16.25a.75.75 0 0 1-.75-.75v-8a.75.75 0 0 1 1.5 0v8a.75.75 0 0 1-.75.75zM8 16.25a.75.75 0 0 1-.75-.75v-8a.75.75 0 0 1 1.5 0v8a.75.75 0 0 1-.75.75z"/></svg>
                        </div>
                        <div className={`w-14 h-14 rounded-full flex-shrink-0 bg-[#0f1428] border border-white/20 overflow-hidden grid place-items-center font-bold text-xl transition-all ${player.id === gameState.nextDealerId ? 'border-4 border-green-400' : ''}`}>
                          {player.avatar ? <img src={player.avatar} alt={player.name} className="w-full h-full object-cover" /> : getInitials(player.name)}
                        </div>
                        <div className="flex-1 truncate">
                          <h3 className="text-xl font-bold truncate">{player.name}</h3>
                        </div>
                        <div className="text-right font-bold text-lg">
                          <div className="text-sm text-red-400">{player.reenganches > 0 && `★ ${player.reenganches}`}</div>
                          <div className={`text-2xl ${player.score > gameState.limit ? 'text-red-400' : ''}`}>{player.score}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <button onClick={() => addPlayer()} className="w-full p-3 border border-white/20 border-dashed rounded-lg text-white/70 hover:bg-white/5 transition-all">+ Add player</button>
                </section>
        
                {gameState.gameOver && (
                  <section className="p-4 rounded-xl border border-white/20 bg-gradient-to-r from-green-600/30 to-blue-600/30 text-white flex items-center justify-between gap-4 flex-wrap">
                    <strong>Game over!</strong>
                    <span className="bg-gray-900/50 text-white/80 py-1 px-3 rounded-full text-xs font-semibold">Game over</span>
                    <div className="flex gap-2 ml-auto">
                      <button onClick={resetGame} className="p-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold transition-all">New game</button>
                    </div>
                  </section>
                )}
              </div>
        
              {showSettingsModal && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                  <div className="bg-[#111827] w-full max-w-xl rounded-2xl border border-white/20 shadow-xl">
                    <div className="p-4 border-b border-white/20 flex justify-between items-center">
                      <h3 className="text-lg font-bold">Settings</h3>
                      <button onClick={() => setShowSettingsModal(false)} className="p-2 text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
                      </button>
                    </div>
                    <div className="p-6 space-y-4">
                      <div>
                        <label className="block text-sm text-gray-400 mb-2">Limit (default 100)</label>
                        <input
                          type="number"
                          value={gameState.limit}
                          onChange={(e) => setGameState(prev => ({ ...prev, limit: clampInt(e.target.value) }))}
                          className="w-full p-2 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={gameState.autoAdvanceDealer}
                          onChange={(e) => setGameState(prev => ({ ...prev, autoAdvanceDealer: e.target.checked }))}
                          className="w-5 h-5 accent-blue-500"
                        />
                        <span className="text-sm">Auto-advance dealer after round</span>
                      </label>
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={gameState.lockOrder}
                          onChange={(e) => setGameState(prev => ({ ...prev, lockOrder: e.target.checked }))}
                          className="w-5 h-5 accent-blue-500"
                        />
                        <span className="text-sm">Lock player reordering</span>
                      </label>
                      <div className="flex gap-2 justify-end mt-4">
                        <button onClick={() => createCSV(players, gameState.nextDealerId)} className="p-2 bg-gray-600 rounded-lg text-white font-bold">Export CSV</button>
                        <button onClick={() => { if (window.confirm("Are you sure you want to reset all scores?")) { resetGame(); setShowSettingsModal(false); } }} className="p-2 bg-yellow-500 rounded-lg text-white font-bold">Reset Scores</button>
                        <button onClick={() => { if (window.confirm("Are you sure you want to clear all players and data?")) { clearAllData(); setShowSettingsModal(false); } }} className="p-2 bg-red-500 rounded-lg text-white font-bold">Clear All</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
        
              {showRoundModal && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                  <div className="bg-[#111827] w-full max-w-xl rounded-2xl border border-white/20 shadow-xl">
                    <div className="p-4 border-b border-white/20 flex justify-between items-center">
                      <h3 className="text-lg font-bold">New Round</h3>
                      <button onClick={() => setShowRoundModal(false)} className="p-2 text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
                      </button>
                    </div>
                    <form onSubmit={saveRound}>
                      <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                        {players.map(p => (
                          <div key={p.id} className="flex items-center gap-2">
                            <span className="w-1/4 truncate">{p.name}</span>
                            <input
                              type="number"
                              value={roundScores[p.id] || ''}
                              onChange={(e) => setRoundScores(prev => ({ ...prev, [p.id]: clampInt(e.target.value) }))}
                              placeholder="Score"
                              className="flex-1 p-2 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                            <label className="flex items-center gap-1 cursor-pointer">
                              <input
                                type="radio"
                                name="cutter"
                                value={p.id}
                                checked={roundCutterId === p.id}
                                onChange={(e) => {
                                  const newCutterId = e.target.value;
                                  setRoundCutterId(newCutterId);
                                  validateRound(roundScores, newCutterId);
                                }}
                                className="w-4 h-4 accent-blue-500"
                              />
                              <span className="text-sm">✂️</span>
                            </label>
                          </div>
                        ))}
                      </div>
                      <div className="p-4 border-t border-white/20 flex items-center justify-between">
                        {roundError && <span className="text-red-400 text-sm font-bold">{roundError}</span>}
                        <button type="button" onClick={() => setShowRoundModal(false)} className="p-2 text-gray-400 hover:text-white transition-colors">Cancel</button>
                        <button type="submit" className="p-3 bg-green-500 hover:bg-green-600 rounded-lg text-white font-bold" disabled={roundError}>Apply</button>
                      </div>
                    </form>
                  </div>
                </div>
              )}
        
              {showEditModal && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                  <div className="bg-[#111827] w-full max-w-xl rounded-2xl border border-white/20 shadow-xl">
                    <div className="p-4 border-b border-white/20 flex justify-between items-center">
                      <h3 className="text-lg font-bold">Edit Player</h3>
                      <button onClick={() => setShowEditModal(false)} className="p-2 text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
                      </button>
                    </div>
                    <form onSubmit={saveEditPlayer}>
                      <div className="p-6 space-y-4">
                        <div>
                          <label className="block text-sm text-gray-400 mb-2">Name</label>
                          <input
                            type="text"
                            value={editPlayerName}
                            onChange={(e) => setEditPlayerName(e.target.value)}
                            required
                            className="w-full p-2 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm text-gray-400 mb-2">Score</label>
                          <input
                            type="number"
                            value={editPlayerScore}
                            onChange={(e) => setEditPlayerScore(e.target.value)}
                            className="w-full p-2 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm text-gray-400 mb-2">Reenganches</label>
                          <input
                            type="number"
                            value={editPlayerReeng}
                            onChange={(e) => setEditPlayerReeng(e.target.value)}
                            min="0"
                            className="w-full p-2 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={editPlayerIsDealer}
                            onChange={(e) => setEditPlayerIsDealer(e.target.checked)}
                            className="w-5 h-5 accent-blue-500"
                          />
                          <span className="text-sm">Set as next dealer</span>
                        </label>
                        <div className="flex gap-2 flex-wrap">
                          <input
                            type="file"
                            accept="image/*"
                            onChange={(e) => {
                              const file = e.target.files[0];
                              if (file) {
                                const reader = new FileReader();
                                reader.onloadend = () => setEditPlayerPhoto(reader.result);
                                reader.readAsDataURL(file);
                              }
                            }}
                          />
                          <button type="button" onClick={() => setEditPlayerPhoto(null)} className="p-2 bg-gray-600 rounded-lg text-white font-bold">Remove Photo</button>
                          <button type="button" onClick={() => setShowCutsHistoryModal(true)} className="p-2 bg-gray-600 rounded-lg text-white font-bold">View Cut History</button>
                          <button type="button" onClick={() => removePlayer(editPlayerId)} className="p-2 bg-red-500 rounded-lg text-white font-bold">Delete Player</button>
                        </div>
                      </div>
                      <div className="p-4 border-t border-white/20 flex justify-end gap-2">
                        <button type="button" onClick={() => setShowEditModal(false)} className="p-2 text-gray-400 hover:text-white transition-colors">Cancel</button>
                        <button type="submit" className="p-3 bg-green-500 hover:bg-green-600 rounded-lg text-white font-bold">Save</button>
                      </div>
                    </form>
                  </div>
                </div>
              )}
        
              {showHistoryModal && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                  <div className="bg-[#111827] w-full max-w-3xl rounded-2xl border border-white/20 shadow-xl">
                    <div className="p-4 border-b border-white/20 flex justify-between items-center">
                      <h3 className="text-lg font-bold">Rounds History</h3>
                      <button onClick={() => setShowHistoryModal(false)} className="p-2 text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
                      </button>
                    </div>
                    <div className="p-6 overflow-x-auto">
                      {gameState.rounds.length === 0 ? (
                        <p className="text-gray-400">No rounds yet.</p>
                      ) : (
                        <table className="min-w-full text-left table-auto border-collapse">
                          <thead className="sticky top-0 bg-[#121633]">
                            <tr>
                              <th className="p-2 font-bold">Round #</th>
                              {players.map(p => <th key={p.id} className="p-2 font-bold">{p.name}</th>)}
                            </tr>
                          </thead>
                          <tbody>
                            {gameState.rounds.map((round, index) => (
                              <tr key={index} className="border-t border-white/10">
                                <td className="p-2">{round.round}</td>
                                {players.map(p => (
                                  <td key={p.id} className="p-2">{round.totals[p.id]}</td>
                                ))}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      )}
                    </div>
                  </div>
                </div>
              )}
        
              {showWinOverlay && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                  <div className="bg-[#111827] w-full max-w-xl rounded-2xl border border-white/20 shadow-xl text-center p-8">
                    <h3 className="text-4xl font-extrabold text-white mb-4">You have a winner!</h3>
                    <p className="text-xl font-semibold mb-6">Congratulations to <span className="text-green-400">{getWinner()?.name}</span>!</p>
                    <button onClick={() => setShowWinOverlay(false)} className="p-3 bg-green-500 hover:bg-green-600 rounded-lg text-white font-bold transition-all">Close</button>
                  </div>
                </div>
              )}
            </div>
          );
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
    <!-- End of React application -->
</body>
</html>
